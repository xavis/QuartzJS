function initWebGL(e){gl=null;try{gl=e.getContext("webgl")||e.getContext("experimental-webgl")}catch(t){}if(!gl){alert("Unable to initialize WebGL. Your browser may not support it.");gl=null}return gl}var K3D={};K3D.load=function(e,t,n){var r=new XMLHttpRequest;r.open("GET",e,true);r.responseType="arraybuffer";r.onload=function(e){t(e.target.response,n)};r.send()};K3D.save=function(e,t){var n="data:application/octet-stream;base64,"+btoa(K3D.parse._buffToStr(e));window.location.href=n};K3D.clone=function(e){return JSON.parse(JSON.stringify(e))};K3D.bin={};K3D.bin.f=new Float32Array(1);K3D.bin.fb=new Uint8Array(K3D.bin.f.buffer);K3D.bin.rf=function(e,t){var n=K3D.bin.f,r=K3D.bin.fb;for(var i=0;i<4;i++)r[i]=e[t+i];return n[0]};K3D.bin.rsl=function(e,t){return e[t]|e[t+1]<<8};K3D.bin.ril=function(e,t){return e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24};K3D.bin.rASCII0=function(e,t){var n="";while(e[t]!=0)n+=String.fromCharCode(e[t++]);return n};K3D.bin.wf=function(e,t,n){var r=new Float32Array(e.buffer,t,1);r[0]=n};K3D.bin.wsl=function(e,t,n){e[t]=n;e[t+1]=n>>8};K3D.bin.wil=function(e,t,n){e[t]=n;e[t+1]=n>>8;e[t+2]=n>>16;e[t+3]>>24};K3D.parse={};K3D.parse._buffToStr=function(e){var t=new Uint8Array(e);var n="";for(var r=0;r<t.length;r++)n=n.concat(String.fromCharCode(t[r]));return n};K3D.parse._strToBuff=function(e){var t=new ArrayBuffer(e.length);var n=new Uint8Array(t);for(var r=0;r<e.length;r++)n[r]=e.charCodeAt(r);return t};K3D.parse._readLine=function(e,t){var n="";while(e[t]!=10)n+=String.fromCharCode(e[t++]);return n};K3D.parse.fromJSON=function(e){var t=JSON.parse(K3D.parse._buffToStr(e));return t};K3D.parse.toJSON=function(e){var t=JSON.stringify(e);return K3D.parse._strToBuff(t)};K3D.parse.fromOBJ=function(e){var t={};t.groups={};t.c_verts=[];t.c_uvt=[];t.c_norms=[];t.i_verts=[];t.i_uvt=[];t.i_norms=[];var n={from:0,to:0};var r=0;var i=new Uint8Array(e);while(r<i.length){var s=K3D.parse._readLine(i,r);r+=s.length+1;s=s.replace(/ +(?= )/g,"");s=s.replace(/(^\s+|\s+$)/g,"");var o=s.split(" ");if(o[0]=="g"){n.to=t.i_verts.length;if(t.groups[o[1]]==null)t.groups[o[1]]={from:t.i_verts.length,to:0};n=t.groups[o[1]]}if(o[0]=="v"){var u=parseFloat(o[1]);var a=parseFloat(o[2]);var f=parseFloat(o[3]);t.c_verts.push(u,a,f)}if(o[0]=="vt"){var u=parseFloat(o[1]);var a=1-parseFloat(o[2]);t.c_uvt.push(u,a)}if(o[0]=="vn"){var u=parseFloat(o[1]);var a=parseFloat(o[2]);var f=parseFloat(o[3]);t.c_norms.push(u,a,f)}if(o[0]=="f"){var l=o[1].split("/"),c=o[2].split("/"),h=o[3].split("/");var p=parseInt(l[0])-1,d=parseInt(c[0])-1,v=parseInt(h[0])-1;var m=parseInt(l[1])-1,g=parseInt(c[1])-1,y=parseInt(h[1])-1;var b=parseInt(l[2])-1,w=parseInt(c[2])-1,E=parseInt(h[2])-1;var S=t.c_verts.length/3,x=t.c_uvt.length/2,T=t.c_norms.length/3;if(p<0)p=S+p+1;if(d<0)d=S+d+1;if(v<0)v=S+v+1;if(m<0)m=x+m+1;if(g<0)g=x+g+1;if(y<0)y=x+y+1;if(b<0)b=T+b+1;if(w<0)w=T+w+1;if(E<0)E=T+E+1;t.i_verts.push(p,d,v);t.i_uvt.push(m,g,y);t.i_norms.push(b,w,E);if(o.length==5){var N=o[4].split("/");var C=parseInt(N[0])-1,k=parseInt(N[1])-1,L=parseInt(N[2])-1;if(C<0)C=S+C+1;if(k<0)k=x+k+1;if(L<0)L=T+L+1;t.i_verts.push(p,v,C);t.i_uvt.push(m,y,k);t.i_norms.push(b,E,L)}}}n.to=t.i_verts.length;return t};K3D.parse.fromMD2=function(e){e=new Uint8Array(e);var t={};var n={};n.ident=K3D.bin.ril(e,0);n.version=K3D.bin.ril(e,4);n.skinwidth=K3D.bin.ril(e,8);n.skinheight=K3D.bin.ril(e,12);n.framesize=K3D.bin.ril(e,16);n.num_skins=K3D.bin.ril(e,20);n.num_vertices=K3D.bin.ril(e,24);n.num_st=K3D.bin.ril(e,28);n.num_tris=K3D.bin.ril(e,32);n.num_glcmds=K3D.bin.ril(e,36);n.num_frames=K3D.bin.ril(e,40);n.offset_skins=K3D.bin.ril(e,44);n.offset_st=K3D.bin.ril(e,48);n.offset_tris=K3D.bin.ril(e,52);n.offset_frames=K3D.bin.ril(e,56);n.offset_glcmds=K3D.bin.ril(e,60);n.offset_end=K3D.bin.ril(e,64);var r=n.offset_st;t.c_uvt=[];for(var i=0;i<n.num_st;i++){var s=K3D.bin.rsl(e,r)/n.skinwidth;var o=K3D.bin.rsl(e,r+2)/n.skinheight;t.c_uvt.push(s,o);r+=4}var r=n.offset_tris;var u=[],a=[];t.i_verts=u;t.i_uvt=a;for(var i=0;i<n.num_tris;i++){u.push(K3D.bin.rsl(e,r),K3D.bin.rsl(e,r+2),K3D.bin.rsl(e,r+4));a.push(K3D.bin.rsl(e,r+6),K3D.bin.rsl(e,r+8),K3D.bin.rsl(e,r+10));r+=12}var r=n.offset_skins;t.skins=[];for(var i=0;i<n.num_skins;i++){t.skins.push(K3D.bin.rASCII0(e,r));r+=64}var r=n.offset_frames;t.frames=[];var f=K3D.parse.fromMD2._normals;for(var i=0;i<n.num_frames;i++){var l={};var c=K3D.bin.rf(e,r),h=K3D.bin.rf(e,r+4),p=K3D.bin.rf(e,r+8);r+=12;var d=K3D.bin.rf(e,r),v=K3D.bin.rf(e,r+4),m=K3D.bin.rf(e,r+8);r+=12;l.name=K3D.bin.rASCII0(e,r);r+=16;l.verts=[];l.norms=[];for(var g=0;g<n.num_vertices;g++){l.verts.push(e[r]*c+d,e[r+1]*h+v,e[r+2]*p+m);l.norms.push(f[3*e[r+3]],f[3*e[r+3]+1],f[3*e[r+3]+2]);r+=4}t.frames.push(l)}return t};K3D.parse.fromMD2._normals=[-.525731,0,.850651,-.442863,.238856,.864188,-.295242,0,.955423,-.309017,.5,.809017,-.16246,.262866,.951056,0,0,1,0,.850651,.525731,-.147621,.716567,.681718,.147621,.716567,.681718,0,.525731,.850651,.309017,.5,.809017,.525731,0,.850651,.295242,0,.955423,.442863,.238856,.864188,.16246,.262866,.951056,-.681718,.147621,.716567,-.809017,.309017,.5,-.587785,.425325,.688191,-.850651,.525731,0,-.864188,.442863,.238856,-.716567,.681718,.147621,-.688191,.587785,.425325,-.5,.809017,.309017,-.238856,.864188,.442863,-.425325,.688191,.587785,-.716567,.681718,-.147621,-.5,.809017,-.309017,-.525731,.850651,0,0,.850651,-.525731,-.238856,.864188,-.442863,0,.955423,-.295242,-.262866,.951056,-.16246,0,1,0,0,.955423,.295242,-.262866,.951056,.16246,.238856,.864188,.442863,.262866,.951056,.16246,.5,.809017,.309017,.238856,.864188,-.442863,.262866,.951056,-.16246,.5,.809017,-.309017,.850651,.525731,0,.716567,.681718,.147621,.716567,.681718,-.147621,.525731,.850651,0,.425325,.688191,.587785,.864188,.442863,.238856,.688191,.587785,.425325,.809017,.309017,.5,.681718,.147621,.716567,.587785,.425325,.688191,.955423,.295242,0,1,0,0,.951056,.16246,.262866,.850651,-.525731,0,.955423,-.295242,0,.864188,-.442863,.238856,.951056,-.16246,.262866,.809017,-.309017,.5,.681718,-.147621,.716567,.850651,0,.525731,.864188,.442863,-.238856,.809017,.309017,-.5,.951056,.16246,-.262866,.525731,0,-.850651,.681718,.147621,-.716567,.681718,-.147621,-.716567,.850651,0,-.525731,.809017,-.309017,-.5,.864188,-.442863,-.238856,.951056,-.16246,-.262866,.147621,.716567,-.681718,.309017,.5,-.809017,.425325,.688191,-.587785,.442863,.238856,-.864188,.587785,.425325,-.688191,.688191,.587785,-.425325,-.147621,.716567,-.681718,-.309017,.5,-.809017,0,.525731,-.850651,-.525731,0,-.850651,-.442863,.238856,-.864188,-.295242,0,-.955423,-.16246,.262866,-.951056,0,0,-1,.295242,0,-.955423,.16246,.262866,-.951056,-.442863,-.238856,-.864188,-.309017,-.5,-.809017,-.16246,-.262866,-.951056,0,-.850651,-.525731,-.147621,-.716567,-.681718,.147621,-.716567,-.681718,0,-.525731,-.850651,.309017,-.5,-.809017,.442863,-.238856,-.864188,.16246,-.262866,-.951056,.238856,-.864188,-.442863,.5,-.809017,-.309017,.425325,-.688191,-.587785,.716567,-.681718,-.147621,.688191,-.587785,-.425325,.587785,-.425325,-.688191,0,-.955423,-.295242,0,-1,0,.262866,-.951056,-.16246,0,-.850651,.525731,0,-.955423,.295242,.238856,-.864188,.442863,.262866,-.951056,.16246,.5,-.809017,.309017,.716567,-.681718,.147621,.525731,-.850651,0,-.238856,-.864188,-.442863,-.5,-.809017,-.309017,-.262866,-.951056,-.16246,-.850651,-.525731,0,-.716567,-.681718,-.147621,-.716567,-.681718,.147621,-.525731,-.850651,0,-.5,-.809017,.309017,-.238856,-.864188,.442863,-.262866,-.951056,.16246,-.864188,-.442863,.238856,-.809017,-.309017,.5,-.688191,-.587785,.425325,-.681718,-.147621,.716567,-.442863,-.238856,.864188,-.587785,-.425325,.688191,-.309017,-.5,.809017,-.147621,-.716567,.681718,-.425325,-.688191,.587785,-.16246,-.262866,.951056,.442863,-.238856,.864188,.16246,-.262866,.951056,.309017,-.5,.809017,.147621,-.716567,.681718,0,-.525731,.850651,.425325,-.688191,.587785,.587785,-.425325,.688191,.688191,-.587785,.425325,-.955423,.295242,0,-.951056,.16246,.262866,-1,0,0,-.850651,0,.525731,-.955423,-.295242,0,-.951056,-.16246,.262866,-.864188,.442863,-.238856,-.951056,.16246,-.262866,-.809017,.309017,-.5,-.864188,-.442863,-.238856,-.951056,-.16246,-.262866,-.809017,-.309017,-.5,-.681718,.147621,-.716567,-.681718,-.147621,-.716567,-.850651,0,-.525731,-.688191,.587785,-.425325,-.587785,.425325,-.688191,-.425325,.688191,-.587785,-.425325,-.688191,-.587785,-.587785,-.425325,-.688191,-.688191,-.587785,-.425325];K3D.parse.fromCollada=function(e){var t=K3D.parse._buffToStr(e);var n=(new DOMParser).parseFromString(t,"text/xml");n=n.childNodes[0];var r={};var i=n.getElementsByTagName("asset")[0];var s=n.getElementsByTagName("library_geometries")[0];var o=n.getElementsByTagName("library_images")[0];var u=n.getElementsByTagName("library_materials")[0];var a=n.getElementsByTagName("library_effects")[0];if(i)r.asset=K3D.parse.fromCollada._asset(i);if(s)r.geometries=K3D.parse.fromCollada._libGeometries(s);if(o)r.images=K3D.parse.fromCollada._libImages(o);if(u)r.materials=K3D.parse.fromCollada._libMaterials(u);if(a)r.effects=K3D.parse.fromCollada._libEffects(a);return r};K3D.parse.fromCollada._asset=function(e){return{created:e.getElementsByTagName("created")[0].textContent,modified:e.getElementsByTagName("modified")[0].textContent,up_axis:e.getElementsByTagName("up_axis")[0].textContent}};K3D.parse.fromCollada._libGeometries=function(e){e=e.getElementsByTagName("geometry");var t=[];for(var n=0;n<e.length;n++){var r=e[n];var i=K3D.parse.fromCollada._getMesh(r.getElementsByTagName("mesh")[0]);t.push(i)}return t};K3D.parse.fromCollada._getMesh=function(e){var t={};var n=e.getElementsByTagName("source");var r=t.sources={};for(var i=0;i<n.length;i++){var s=n[i].getElementsByTagName("float_array")[0].textContent.split(" ");var o=s.length-(s[s.length-1]==""?1:0);var u=new Array(o);for(var a=0;a<o;a++)u[a]=parseFloat(s[a]);r[n[i].getAttribute("id")]=u}t.triangles=[];var f=e.getElementsByTagName("triangles");if(f==null)return t;for(var i=0;i<f.length;i++){var l={};var c=f[i];l.material=c.getAttribute("material");var h=c.getElementsByTagName("input");var p=[];for(var a=0;a<h.length;a++){var d=h[a],u=[];p[parseInt(d.getAttribute("offset"))]=u;var v=d.getAttribute("semantic");l["s_"+v]=v=="VERTEX"?e.getElementsByTagName("vertices")[0].getElementsByTagName("input")[0].getAttribute("source").substring(1):d.getAttribute("source").substring(1);l["i_"+v]=u;var m=r[l["s_"+v]]}var g=c.getElementsByTagName("p")[0].textContent.split(" ");var y=3*Math.floor(g.length/3);for(var a=0;a<y;a++)p[a%h.length].push(parseInt(g[a]));t.triangles.push(l)}return t};K3D.parse.fromCollada._libImages=function(e){e=e.getElementsByTagName("image");var t={};for(var n=0;n<e.length;n++){t[e[n].getAttribute("id")]=e[n].getElementsByTagName("init_from")[0].textContent}return t};K3D.parse.fromCollada._libMaterials=function(e){e=e.getElementsByTagName("material");var t={};for(var n=0;n<e.length;n++){t[e[n].getAttribute("name")]=e[n].getElementsByTagName("instance_effect")[0].getAttribute("url").substring(1)}return t};K3D.parse.fromCollada._libEffects=function(e){e=e.getElementsByTagName("effect");var t={};for(var n=0;n<e.length;n++){var r={};var i=e[n].getElementsByTagName("newparam");for(var s=0;s<i.length;s++){var o=i[s].getElementsByTagName("surface")[0];if(o)r.surface=o.getElementsByTagName("init_from")[0].textContent}t[e[n].getAttribute("id")]=r}return t};K3D.parse.from3DS=function(e){e=new Uint8Array(e);var t={};if(K3D.bin.rsl(e,0)!=19789)return null;var n=K3D.bin.ril(e,2);var r=6;while(r<n){var i=K3D.bin.rsl(e,r);var s=K3D.bin.ril(e,r+2);if(i==15677)t.edit=K3D.parse.from3DS._edit3ds(e,r,s);if(i==45056)t.keyf=K3D.parse.from3DS._keyf3ds(e,r,s);r+=s}return t};K3D.parse.from3DS._edit3ds=function(e,t,n){var r={};var i=t+6;while(i<t+n){var s=K3D.bin.rsl(e,i);var o=K3D.bin.ril(e,i+2);if(s==16384){if(r.objects==null)r.objects=[];r.objects.push(K3D.parse.from3DS._edit_object(e,i,o))}i+=o}return r};K3D.parse.from3DS._keyf3ds=function(e,t,n){var r={};var i=t+6;while(i<t+n){var s=K3D.bin.rsl(e,i);var o=K3D.bin.ril(e,i+2);if(s==45058){if(r.desc==null)r.desc=[];r.desc.push(K3D.parse.from3DS._keyf_objdes(e,i,o))}i+=o}return r};K3D.parse.from3DS._keyf_objdes=function(e,t,n){var r={};var i=t+6;while(i<t+n){var s=K3D.bin.rsl(e,i);var o=K3D.bin.ril(e,i+2);if(s==45072)r.hierarchy=K3D.parse.from3DS._keyf_objhierarch(e,i,o);if(s==45073)r.dummy_name=K3D.bin.rASCII0(e,i+6);i+=o}return r};K3D.parse.from3DS._keyf_objhierarch=function(e,t,n){var r={};var i=t+6;r.name=K3D.bin.rASCII0(e,i);i+=r.name.length+1;r.hierarchy=K3D.bin.rsl(e,i+4);return r};K3D.parse.from3DS._edit_object=function(e,t,n){var r={};var i=t+6;r.name=K3D.bin.rASCII0(e,i);i+=r.name.length+1;while(i<t+n){var s=K3D.bin.rsl(e,i);var o=K3D.bin.ril(e,i+2);if(s==16640)r.mesh=K3D.parse.from3DS._obj_trimesh(e,i,o);i+=o}return r};K3D.parse.from3DS._obj_trimesh=function(e,t,n){var r={};var i=t+6;while(i<t+n){var s=K3D.bin.rsl(e,i);var o=K3D.bin.ril(e,i+2);if(s==16656)r.vertices=K3D.parse.from3DS._tri_vertexl(e,i,o);if(s==16672)r.indices=K3D.parse.from3DS._tri_facel1(e,i,o);if(s==16704)r.uvt=K3D.parse.from3DS._tri_mappingcoors(e,i,o);if(s==16736)r.local=K3D.parse.from3DS._tri_local(e,i,o);i+=o}return r};K3D.parse.from3DS._tri_vertexl=function(e,t,n){var r=[];var i=t+6;var s=K3D.bin.rsl(e,i);i+=2;for(var o=0;o<s;o++){r.push(K3D.bin.rf(e,i));r.push(K3D.bin.rf(e,i+4));r.push(K3D.bin.rf(e,i+8));i+=12}return r};K3D.parse.from3DS._tri_facel1=function(e,t,n){var r=[];var i=t+6;var s=K3D.bin.rsl(e,i);i+=2;for(var o=0;o<s;o++){r.push(K3D.bin.rsl(e,i));r.push(K3D.bin.rsl(e,i+2));r.push(K3D.bin.rsl(e,i+4));i+=8}return r};K3D.parse.from3DS._tri_mappingcoors=function(e,t,n){var r=[];var i=t+6;var s=K3D.bin.rsl(e,i);i+=2;for(var o=0;o<s;o++){r.push(K3D.bin.rf(e,i));r.push(1-K3D.bin.rf(e,i+4));i+=8}return r};K3D.parse.from3DS._tri_local=function(e,t,n){var r={};var i=t+6;r.X=[K3D.bin.rf(e,i),K3D.bin.rf(e,i+4),K3D.bin.rf(e,i+8)];i+=12;r.Y=[K3D.bin.rf(e,i),K3D.bin.rf(e,i+4),K3D.bin.rf(e,i+8)];i+=12;r.Z=[K3D.bin.rf(e,i),K3D.bin.rf(e,i+4),K3D.bin.rf(e,i+8)];i+=12;r.C=[K3D.bin.rf(e,i),K3D.bin.rf(e,i+4),K3D.bin.rf(e,i+8)];i+=12;return r};K3D.parse.fromBIV=function(e){e=new Uint8Array(e);var t={};var n={};n.id=K3D.bin.ril(e,0);n.verS=K3D.bin.ril(e,4);n.texS=K3D.bin.ril(e,8);n.indS=K3D.bin.ril(e,12);n.verO=K3D.bin.ril(e,16);n.verL=K3D.bin.ril(e,20);n.texO=K3D.bin.ril(e,24);n.texL=K3D.bin.ril(e,28);n.indO=K3D.bin.ril(e,32);n.indL=K3D.bin.ril(e,36);if(n.verO!=0)t.vertices=K3D.parse.fromBIV._readFloats(e,n.verO,n.verL);if(n.texO!=0)t.uvt=K3D.parse.fromBIV._readFloats(e,n.texO,n.texL);if(n.indO!=0)t.indices=K3D.parse.fromBIV._readInts(e,n.indO,n.indL,n.indS);return t};K3D.parse.toBIV=function(e){var t=0;for(var n=0;n<e.indices.length;n++)t=Math.max(t,e.indices[n]);var r=32;if(t<=65535)r=16;var i=40;if(e.vertices)i+=e.vertices.length*4;if(e.uvt)i+=e.uvt.length*4;if(e.indices)i+=e.indices.length*r/8;var s=new Uint8Array(i);K3D.bin.wil(s,0,1769365870);K3D.bin.wil(s,4,32);K3D.bin.wil(s,8,32);K3D.bin.wil(s,12,r);var o=40;if(e.vertices){K3D.bin.wil(s,16,o);K3D.bin.wil(s,20,4*e.vertices.length);K3D.parse.fromBIV._writeFloats(s,o,e.vertices);o+=4*e.vertices.length}if(e.uvt){K3D.bin.wil(s,24,o);K3D.bin.wil(s,28,4*e.uvt.length);K3D.parse.fromBIV._writeFloats(s,o,e.uvt);o+=4*e.uvt.length}if(e.indices){K3D.bin.wil(s,32,o);K3D.bin.wil(s,36,4*e.indices.length);K3D.parse.fromBIV._writeInts(s,o,e.indices,r)}return s.buffer};K3D.parse.fromBIV._readFloats=function(e,t,n){var r=[];for(var i=0;i<n/4;i++)r.push(K3D.bin.rf(e,t+4*i));return r};K3D.parse.fromBIV._writeFloats=function(e,t,n){for(var r=0;r<n.length;r++)K3D.bin.wf(e,t+4*r,n[r])};K3D.parse.fromBIV._readInts=function(e,t,n,r){var i=[];for(var s=0;s<n/4;s++){if(r==16)i.push(K3D.bin.rsl(e,t+2*s));if(r==32)i.push(K3D.bin.ril(e,t+4*s))}return i};K3D.parse.fromBIV._writeInts=function(e,t,n,r){for(var i=0;i<n.length;i++){if(r==16)K3D.bin.wsl(e,t+2*i,n[i]);if(r==32)K3D.bin.wil(e,t+4*i,n[i])}};K3D.gen={};K3D.gen.Plane=function(e,t,n,r){if(!n)n=1;if(!r)r=1;var i={verts:[],inds:[],uvt:[]};var s=e+1,o=t+1;for(var u=0;u<o;u++){for(var a=0;a<s;a++){var f=-1+a*(2/e);var l=-1+u*(2/t);i.verts.push(f,l,0);i.uvt.push(n*a/e,r*u/t);if(u<t&&a<e)i.inds.push(u*s+a,u*s+a+1,(u+1)*s+a,u*s+a+1,(u+1)*s+a,(u+1)*s+a+1)}}return i};K3D.gen.Cube=function(){var e={verts:[-1,1,-1,1,1,-1,-1,-1,-1,1,-1,-1,-1,1,1,1,1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,-1,1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,-1,1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,-1,-1,1,1,-1,1],inds:[0,1,2,1,2,3,4,5,6,5,6,7,8,9,10,9,10,11,12,13,14,13,14,15,16,17,18,17,18,19,20,21,22,21,22,23],uvt:[1/4,1/4,2/4,1/4,1/4,2/4,2/4,2/4,4/4,1/4,3/4,1/4,4/4,2/4,3/4,2/4,0/4,1/4,1/4,1/4,0/4,2/4,1/4,2/4,3/4,1/4,2/4,1/4,3/4,2/4,2/4,2/4,1/4,1/4,2/4,1/4,1/4,0/4,2/4,0/4,1/4,2/4,2/4,2/4,1/4,3/4,2/4,3/4]};return e};K3D.gen.Sphere=function(e,t){var n={verts:[],inds:[],uvt:[]};var r=2*Math.PI/e;var i=Math.PI/t;var s=e+1,o=t+1;for(var u=0;u<o;u++){for(var a=0;a<s;a++){var f=-Math.PI/2+u*Math.PI/t;var l=a*2*Math.PI/e;var c=Math.cos(f)*Math.cos(l);var h=Math.sin(f);var p=Math.cos(f)*Math.sin(l);n.verts.push(c,h,p);n.uvt.push(a/e,u/t);if(u<t&&a<e)n.inds.push(s*u+a,s*u+a+1,s*(u+1)+a,s*u+a+1,s*(u+1)+a,s*(u+1)+a+1)}}return n};K3D.mat={};K3D.mat.scale=function(e,t,n){return[e,0,0,0,0,t,0,0,0,0,n,0,0,0,0,1]};K3D.mat.translate=function(e,t,n){return[1,0,0,0,0,1,0,0,0,0,1,0,e,t,n,1]};K3D.mat.rotateDeg=function(e,t,n){var r=Math.PI/180;return K3D.mat.rotate(e*r,t*r,n*r)};K3D.mat.rotate=function(e,t,n){var r=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];var i=e;var s=t;var o=n;var u=Math.cos(i),a=Math.cos(s),f=Math.cos(o);var l=Math.sin(i),c=Math.sin(s),h=Math.sin(o);r[0]=a*f;r[1]=-a*h;r[2]=c;r[4]=u*h+l*c*f;r[5]=u*f-l*c*h;r[6]=-l*a;r[8]=l*h-u*c*f;r[9]=l*f+u*c*h;r[10]=u*a;return r};K3D.edit={};K3D.edit.interpolate=function(e,t,n,r){for(var i=0;i<e.length;i++)n[i]=e[i]+r*(t[i]-e[i])};K3D.edit.transform=function(e,t){for(var n=0;n<e.length;n+=3){var r=e[n],i=e[n+1],s=e[n+2];e[n+0]=t[0]*r+t[4]*i+t[8]*s+t[12];e[n+1]=t[1]*r+t[5]*i+t[9]*s+t[13];e[n+2]=t[2]*r+t[6]*i+t[10]*s+t[14]}};K3D.edit.unwrap=function(e,t,n){var r=new Array(Math.floor(e.length/3)*n);for(var i=0;i<e.length;i++){for(var s=0;s<n;s++){r[i*n+s]=t[e[i]*n+s]}}return r};K3D.edit.remap=function(e,t,n,r){var i=new Array(n.length);for(var s=0;s<e.length;s++){for(var o=0;o<r;o++){i[t[s]*r+o]=n[e[s]*r+o]}}return i};K3D.utils={};K3D.utils.getAABB=function(e){var t,n,r,i,s,o;t=n=r=999999999;i=s=o=-t;for(var u=0;u<e.length;u+=3){var a=e[u+0];var f=e[u+1];var l=e[u+2];if(a<t)t=a;if(a>i)i=a;if(f<n)n=f;if(f>s)s=f;if(l<r)r=l;if(f>o)o=l}return{min:{x:t,y:n,z:r},max:{x:i,y:s,z:o}}};glMatrixArrayType=typeof Float32Array!="undefined"?Float32Array:typeof WebGLFloatArray!="undefined"?WebGLFloatArray:Array;var vec3={};vec3.create=function(e){var t=new glMatrixArrayType(3);if(e){t[0]=e[0];t[1]=e[1];t[2]=e[2]}return t};vec3.set=function(e,t){t[0]=e[0];t[1]=e[1];t[2]=e[2];return t};vec3.add=function(e,t,n){if(!n||e==n){e[0]+=t[0];e[1]+=t[1];e[2]+=t[2];return e}n[0]=e[0]+t[0];n[1]=e[1]+t[1];n[2]=e[2]+t[2];return n};vec3.subtract=function(e,t,n){if(!n||e==n){e[0]-=t[0];e[1]-=t[1];e[2]-=t[2];return e}n[0]=e[0]-t[0];n[1]=e[1]-t[1];n[2]=e[2]-t[2];return n};vec3.negate=function(e,t){t||(t=e);t[0]=-e[0];t[1]=-e[1];t[2]=-e[2];return t};vec3.scale=function(e,t,n){if(!n||e==n){e[0]*=t;e[1]*=t;e[2]*=t;return e}n[0]=e[0]*t;n[1]=e[1]*t;n[2]=e[2]*t;return n};vec3.normalize=function(e,t){t||(t=e);var n=e[0],r=e[1],i=e[2],s=Math.sqrt(n*n+r*r+i*i);if(s){if(s==1){t[0]=n;t[1]=r;t[2]=i;return t}}else{t[0]=0;t[1]=0;t[2]=0;return t}s=1/s;t[0]=n*s;t[1]=r*s;t[2]=i*s;return t};vec3.cross=function(e,t,n){n||(n=e);var r=e[0],i=e[1];e=e[2];var s=t[0],o=t[1];t=t[2];n[0]=i*t-e*o;n[1]=e*s-r*t;n[2]=r*o-i*s;return n};vec3.length=function(e){var t=e[0],n=e[1];e=e[2];return Math.sqrt(t*t+n*n+e*e)};vec3.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]};vec3.direction=function(e,t,n){n||(n=e);var r=e[0]-t[0],i=e[1]-t[1];e=e[2]-t[2];t=Math.sqrt(r*r+i*i+e*e);if(!t){n[0]=0;n[1]=0;n[2]=0;return n}t=1/t;n[0]=r*t;n[1]=i*t;n[2]=e*t;return n};vec3.lerp=function(e,t,n,r){r||(r=e);r[0]=e[0]+n*(t[0]-e[0]);r[1]=e[1]+n*(t[1]-e[1]);r[2]=e[2]+n*(t[2]-e[2]);return r};vec3.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+"]"};var mat3={};mat3.create=function(e){var t=new glMatrixArrayType(9);if(e){t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];t[4]=e[4];t[5]=e[5];t[6]=e[6];t[7]=e[7];t[8]=e[8];t[9]=e[9]}return t};mat3.set=function(e,t){t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];t[4]=e[4];t[5]=e[5];t[6]=e[6];t[7]=e[7];t[8]=e[8];return t};mat3.identity=function(e){e[0]=1;e[1]=0;e[2]=0;e[3]=0;e[4]=1;e[5]=0;e[6]=0;e[7]=0;e[8]=1;return e};mat3.transpose=function(e,t){if(!t||e==t){var n=e[1],r=e[2],i=e[5];e[1]=e[3];e[2]=e[6];e[3]=n;e[5]=e[7];e[6]=r;e[7]=i;return e}t[0]=e[0];t[1]=e[3];t[2]=e[6];t[3]=e[1];t[4]=e[4];t[5]=e[7];t[6]=e[2];t[7]=e[5];t[8]=e[8];return t};mat3.toMat4=function(e,t){t||(t=mat4.create());t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=0;t[4]=e[3];t[5]=e[4];t[6]=e[5];t[7]=0;t[8]=e[6];t[9]=e[7];t[10]=e[8];t[11]=0;t[12]=0;t[13]=0;t[14]=0;t[15]=1;return t};mat3.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+"]"};var mat4={};mat4.create=function(e){var t=new glMatrixArrayType(16);if(e){t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];t[4]=e[4];t[5]=e[5];t[6]=e[6];t[7]=e[7];t[8]=e[8];t[9]=e[9];t[10]=e[10];t[11]=e[11];t[12]=e[12];t[13]=e[13];t[14]=e[14];t[15]=e[15]}return t};mat4.set=function(e,t){t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];t[4]=e[4];t[5]=e[5];t[6]=e[6];t[7]=e[7];t[8]=e[8];t[9]=e[9];t[10]=e[10];t[11]=e[11];t[12]=e[12];t[13]=e[13];t[14]=e[14];t[15]=e[15];return t};mat4.identity=function(e){e[0]=1;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=1;e[6]=0;e[7]=0;e[8]=0;e[9]=0;e[10]=1;e[11]=0;e[12]=0;e[13]=0;e[14]=0;e[15]=1;return e};mat4.transpose=function(e,t){if(!t||e==t){var n=e[1],r=e[2],i=e[3],s=e[6],o=e[7],u=e[11];e[1]=e[4];e[2]=e[8];e[3]=e[12];e[4]=n;e[6]=e[9];e[7]=e[13];e[8]=r;e[9]=s;e[11]=e[14];e[12]=i;e[13]=o;e[14]=u;return e}t[0]=e[0];t[1]=e[4];t[2]=e[8];t[3]=e[12];t[4]=e[1];t[5]=e[5];t[6]=e[9];t[7]=e[13];t[8]=e[2];t[9]=e[6];t[10]=e[10];t[11]=e[14];t[12]=e[3];t[13]=e[7];t[14]=e[11];t[15]=e[15];return t};mat4.determinant=function(e){var t=e[0],n=e[1],r=e[2],i=e[3],s=e[4],o=e[5],u=e[6],a=e[7],f=e[8],l=e[9],c=e[10],h=e[11],p=e[12],d=e[13],v=e[14];e=e[15];return p*l*u*i-f*d*u*i-p*o*c*i+s*d*c*i+f*o*v*i-s*l*v*i-p*l*r*a+f*d*r*a+p*n*c*a-t*d*c*a-f*n*v*a+t*l*v*a+p*o*r*h-s*d*r*h-p*n*u*h+t*d*u*h+s*n*v*h-t*o*v*h-f*o*r*e+s*l*r*e+f*n*u*e-t*l*u*e-s*n*c*e+t*o*c*e};mat4.inverse=function(e,t){t||(t=e);var n=e[0],r=e[1],i=e[2],s=e[3],o=e[4],u=e[5],a=e[6],f=e[7],l=e[8],c=e[9],h=e[10],p=e[11],d=e[12],v=e[13],m=e[14],g=e[15],y=n*u-r*o,b=n*a-i*o,w=n*f-s*o,E=r*a-i*u,S=r*f-s*u,x=i*f-s*a,T=l*v-c*d,N=l*m-h*d,C=l*g-p*d,k=c*m-h*v,L=c*g-p*v,A=h*g-p*m,O=1/(y*A-b*L+w*k+E*C-S*N+x*T);t[0]=(u*A-a*L+f*k)*O;t[1]=(-r*A+i*L-s*k)*O;t[2]=(v*x-m*S+g*E)*O;t[3]=(-c*x+h*S-p*E)*O;t[4]=(-o*A+a*C-f*N)*O;t[5]=(n*A-i*C+s*N)*O;t[6]=(-d*x+m*w-g*b)*O;t[7]=(l*x-h*w+p*b)*O;t[8]=(o*L-u*C+f*T)*O;t[9]=(-n*L+r*C-s*T)*O;t[10]=(d*S-v*w+g*y)*O;t[11]=(-l*S+c*w-p*y)*O;t[12]=(-o*k+u*N-a*T)*O;t[13]=(n*k-r*N+i*T)*O;t[14]=(-d*E+v*b-m*y)*O;t[15]=(l*E-c*b+h*y)*O;return t};mat4.toRotationMat=function(e,t){t||(t=mat4.create());t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];t[4]=e[4];t[5]=e[5];t[6]=e[6];t[7]=e[7];t[8]=e[8];t[9]=e[9];t[10]=e[10];t[11]=e[11];t[12]=0;t[13]=0;t[14]=0;t[15]=1;return t};mat4.toMat3=function(e,t){t||(t=mat3.create());t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[4];t[4]=e[5];t[5]=e[6];t[6]=e[8];t[7]=e[9];t[8]=e[10];return t};mat4.toInverseMat3=function(e,t){var n=e[0],r=e[1],i=e[2],s=e[4],o=e[5],u=e[6],a=e[8],f=e[9],l=e[10],c=l*o-u*f,h=-l*s+u*a,p=f*s-o*a,d=n*c+r*h+i*p;if(!d)return null;d=1/d;t||(t=mat3.create());t[0]=c*d;t[1]=(-l*r+i*f)*d;t[2]=(u*r-i*o)*d;t[3]=h*d;t[4]=(l*n-i*a)*d;t[5]=(-u*n+i*s)*d;t[6]=p*d;t[7]=(-f*n+r*a)*d;t[8]=(o*n-r*s)*d;return t};mat4.multiply=function(e,t,n){n||(n=e);var r=e[0],i=e[1],s=e[2],o=e[3],u=e[4],a=e[5],f=e[6],l=e[7],c=e[8],h=e[9],p=e[10],d=e[11],v=e[12],m=e[13],g=e[14];e=e[15];var y=t[0],b=t[1],w=t[2],E=t[3],S=t[4],x=t[5],T=t[6],N=t[7],C=t[8],k=t[9],L=t[10],A=t[11],O=t[12],M=t[13],_=t[14];t=t[15];n[0]=y*r+b*u+w*c+E*v;n[1]=y*i+b*a+w*h+E*m;n[2]=y*s+b*f+w*p+E*g;n[3]=y*o+b*l+w*d+E*e;n[4]=S*r+x*u+T*c+N*v;n[5]=S*i+x*a+T*h+N*m;n[6]=S*s+x*f+T*p+N*g;n[7]=S*o+x*l+T*d+N*e;n[8]=C*r+k*u+L*c+A*v;n[9]=C*i+k*a+L*h+A*m;n[10]=C*s+k*f+L*p+A*g;n[11]=C*o+k*l+L*d+A*e;n[12]=O*r+M*u+_*c+t*v;n[13]=O*i+M*a+_*h+t*m;n[14]=O*s+M*f+_*p+t*g;n[15]=O*o+M*l+_*d+t*e;return n};mat4.multiplyVec3=function(e,t,n){n||(n=t);var r=t[0],i=t[1];t=t[2];n[0]=e[0]*r+e[4]*i+e[8]*t+e[12];n[1]=e[1]*r+e[5]*i+e[9]*t+e[13];n[2]=e[2]*r+e[6]*i+e[10]*t+e[14];return n};mat4.multiplyVec4=function(e,t,n){n||(n=t);var r=t[0],i=t[1],s=t[2];t=t[3];n[0]=e[0]*r+e[4]*i+e[8]*s+e[12]*t;n[1]=e[1]*r+e[5]*i+e[9]*s+e[13]*t;n[2]=e[2]*r+e[6]*i+e[10]*s+e[14]*t;n[3]=e[3]*r+e[7]*i+e[11]*s+e[15]*t;return n};mat4.translate=function(e,t,n){var r=t[0],i=t[1];t=t[2];if(!n||e==n){e[12]=e[0]*r+e[4]*i+e[8]*t+e[12];e[13]=e[1]*r+e[5]*i+e[9]*t+e[13];e[14]=e[2]*r+e[6]*i+e[10]*t+e[14];e[15]=e[3]*r+e[7]*i+e[11]*t+e[15];return e}var s=e[0],o=e[1],u=e[2],a=e[3],f=e[4],l=e[5],c=e[6],h=e[7],p=e[8],d=e[9],v=e[10],m=e[11];n[0]=s;n[1]=o;n[2]=u;n[3]=a;n[4]=f;n[5]=l;n[6]=c;n[7]=h;n[8]=p;n[9]=d;n[10]=v;n[11]=m;n[12]=s*r+f*i+p*t+e[12];n[13]=o*r+l*i+d*t+e[13];n[14]=u*r+c*i+v*t+e[14];n[15]=a*r+h*i+m*t+e[15];return n};mat4.scale=function(e,t,n){var r=t[0],i=t[1];t=t[2];if(!n||e==n){e[0]*=r;e[1]*=r;e[2]*=r;e[3]*=r;e[4]*=i;e[5]*=i;e[6]*=i;e[7]*=i;e[8]*=t;e[9]*=t;e[10]*=t;e[11]*=t;return e}n[0]=e[0]*r;n[1]=e[1]*r;n[2]=e[2]*r;n[3]=e[3]*r;n[4]=e[4]*i;n[5]=e[5]*i;n[6]=e[6]*i;n[7]=e[7]*i;n[8]=e[8]*t;n[9]=e[9]*t;n[10]=e[10]*t;n[11]=e[11]*t;n[12]=e[12];n[13]=e[13];n[14]=e[14];n[15]=e[15];return n};mat4.rotate=function(e,t,n,r){var i=n[0],s=n[1];n=n[2];var o=Math.sqrt(i*i+s*s+n*n);if(!o)return null;if(o!=1){o=1/o;i*=o;s*=o;n*=o}var u=Math.sin(t),a=Math.cos(t),f=1-a;t=e[0];o=e[1];var l=e[2],c=e[3],h=e[4],p=e[5],d=e[6],v=e[7],m=e[8],g=e[9],y=e[10],b=e[11],w=i*i*f+a,E=s*i*f+n*u,S=n*i*f-s*u,x=i*s*f-n*u,T=s*s*f+a,N=n*s*f+i*u,C=i*n*f+s*u;i=s*n*f-i*u;s=n*n*f+a;if(r){if(e!=r){r[12]=e[12];r[13]=e[13];r[14]=e[14];r[15]=e[15]}}else r=e;r[0]=t*w+h*E+m*S;r[1]=o*w+p*E+g*S;r[2]=l*w+d*E+y*S;r[3]=c*w+v*E+b*S;r[4]=t*x+h*T+m*N;r[5]=o*x+p*T+g*N;r[6]=l*x+d*T+y*N;r[7]=c*x+v*T+b*N;r[8]=t*C+h*i+m*s;r[9]=o*C+p*i+g*s;r[10]=l*C+d*i+y*s;r[11]=c*C+v*i+b*s;return r};mat4.rotateX=function(e,t,n){var r=Math.sin(t);t=Math.cos(t);var i=e[4],s=e[5],o=e[6],u=e[7],a=e[8],f=e[9],l=e[10],c=e[11];if(n){if(e!=n){n[0]=e[0];n[1]=e[1];n[2]=e[2];n[3]=e[3];n[12]=e[12];n[13]=e[13];n[14]=e[14];n[15]=e[15]}}else n=e;n[4]=i*t+a*r;n[5]=s*t+f*r;n[6]=o*t+l*r;n[7]=u*t+c*r;n[8]=i*-r+a*t;n[9]=s*-r+f*t;n[10]=o*-r+l*t;n[11]=u*-r+c*t;return n};mat4.rotateY=function(e,t,n){var r=Math.sin(t);t=Math.cos(t);var i=e[0],s=e[1],o=e[2],u=e[3],a=e[8],f=e[9],l=e[10],c=e[11];if(n){if(e!=n){n[4]=e[4];n[5]=e[5];n[6]=e[6];n[7]=e[7];n[12]=e[12];n[13]=e[13];n[14]=e[14];n[15]=e[15]}}else n=e;n[0]=i*t+a*-r;n[1]=s*t+f*-r;n[2]=o*t+l*-r;n[3]=u*t+c*-r;n[8]=i*r+a*t;n[9]=s*r+f*t;n[10]=o*r+l*t;n[11]=u*r+c*t;return n};mat4.rotateZ=function(e,t,n){var r=Math.sin(t);t=Math.cos(t);var i=e[0],s=e[1],o=e[2],u=e[3],a=e[4],f=e[5],l=e[6],c=e[7];if(n){if(e!=n){n[8]=e[8];n[9]=e[9];n[10]=e[10];n[11]=e[11];n[12]=e[12];n[13]=e[13];n[14]=e[14];n[15]=e[15]}}else n=e;n[0]=i*t+a*r;n[1]=s*t+f*r;n[2]=o*t+l*r;n[3]=u*t+c*r;n[4]=i*-r+a*t;n[5]=s*-r+f*t;n[6]=o*-r+l*t;n[7]=u*-r+c*t;return n};mat4.frustum=function(e,t,n,r,i,s,o){o||(o=mat4.create());var u=t-e,a=r-n,f=s-i;o[0]=i*2/u;o[1]=0;o[2]=0;o[3]=0;o[4]=0;o[5]=i*2/a;o[6]=0;o[7]=0;o[8]=(t+e)/u;o[9]=(r+n)/a;o[10]=-(s+i)/f;o[11]=-1;o[12]=0;o[13]=0;o[14]=-(s*i*2)/f;o[15]=0;return o};mat4.perspective=function(e,t,n,r,i){e=n*Math.tan(e*Math.PI/360);t=e*t;return mat4.frustum(-t,t,-e,e,n,r,i)};mat4.ortho=function(e,t,n,r,i,s,o){o||(o=mat4.create());var u=t-e,a=r-n,f=s-i;o[0]=2/u;o[1]=0;o[2]=0;o[3]=0;o[4]=0;o[5]=2/a;o[6]=0;o[7]=0;o[8]=0;o[9]=0;o[10]=-2/f;o[11]=0;o[12]=-(e+t)/u;o[13]=-(r+n)/a;o[14]=-(s+i)/f;o[15]=1;return o};mat4.lookAt=function(e,t,n,r){r||(r=mat4.create());var i=e[0],s=e[1];e=e[2];var o=n[0],u=n[1],a=n[2];n=t[1];var f=t[2];if(i==t[0]&&s==n&&e==f)return mat4.identity(r);var l,c,h,p;n=i-t[0];f=s-t[1];t=e-t[2];p=1/Math.sqrt(n*n+f*f+t*t);n*=p;f*=p;t*=p;l=u*t-a*f;a=a*n-o*t;o=o*f-u*n;if(p=Math.sqrt(l*l+a*a+o*o)){p=1/p;l*=p;a*=p;o*=p}else o=a=l=0;u=f*o-t*a;c=t*l-n*o;h=n*a-f*l;if(p=Math.sqrt(u*u+c*c+h*h)){p=1/p;u*=p;c*=p;h*=p}else h=c=u=0;r[0]=l;r[1]=u;r[2]=n;r[3]=0;r[4]=a;r[5]=c;r[6]=f;r[7]=0;r[8]=o;r[9]=h;r[10]=t;r[11]=0;r[12]=-(l*i+a*s+o*e);r[13]=-(u*i+c*s+h*e);r[14]=-(n*i+f*s+t*e);r[15]=1;return r};mat4.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+"]"};quat4={};quat4.create=function(e){var t=new glMatrixArrayType(4);if(e){t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3]}return t};quat4.set=function(e,t){t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];return t};quat4.calculateW=function(e,t){var n=e[0],r=e[1],i=e[2];if(!t||e==t){e[3]=-Math.sqrt(Math.abs(1-n*n-r*r-i*i));return e}t[0]=n;t[1]=r;t[2]=i;t[3]=-Math.sqrt(Math.abs(1-n*n-r*r-i*i));return t};quat4.inverse=function(e,t){if(!t||e==t){e[0]*=1;e[1]*=1;e[2]*=1;return e}t[0]=-e[0];t[1]=-e[1];t[2]=-e[2];t[3]=e[3];return t};quat4.length=function(e){var t=e[0],n=e[1],r=e[2];e=e[3];return Math.sqrt(t*t+n*n+r*r+e*e)};quat4.normalize=function(e,t){t||(t=e);var n=e[0],r=e[1],i=e[2],s=e[3],o=Math.sqrt(n*n+r*r+i*i+s*s);if(o==0){t[0]=0;t[1]=0;t[2]=0;t[3]=0;return t}o=1/o;t[0]=n*o;t[1]=r*o;t[2]=i*o;t[3]=s*o;return t};quat4.multiply=function(e,t,n){n||(n=e);var r=e[0],i=e[1],s=e[2];e=e[3];var o=t[0],u=t[1],a=t[2];t=t[3];n[0]=r*t+e*o+i*a-s*u;n[1]=i*t+e*u+s*o-r*a;n[2]=s*t+e*a+r*u-i*o;n[3]=e*t-r*o-i*u-s*a;return n};quat4.multiplyVec3=function(e,t,n){n||(n=t);var r=t[0],i=t[1],s=t[2];t=e[0];var o=e[1],u=e[2];e=e[3];var a=e*r+o*s-u*i,f=e*i+u*r-t*s,l=e*s+t*i-o*r;r=-t*r-o*i-u*s;n[0]=a*e+r*-t+f*-u-l*-o;n[1]=f*e+r*-o+l*-t-a*-u;n[2]=l*e+r*-u+a*-o-f*-t;return n};quat4.toMat3=function(e,t){t||(t=mat3.create());var n=e[0],r=e[1],i=e[2],s=e[3],o=n+n,u=r+r,a=i+i,f=n*o,l=n*u;n=n*a;var c=r*u;r=r*a;i=i*a;o=s*o;u=s*u;s=s*a;t[0]=1-(c+i);t[1]=l-s;t[2]=n+u;t[3]=l+s;t[4]=1-(f+i);t[5]=r-o;t[6]=n-u;t[7]=r+o;t[8]=1-(f+c);return t};quat4.toMat4=function(e,t){t||(t=mat4.create());var n=e[0],r=e[1],i=e[2],s=e[3],o=n+n,u=r+r,a=i+i,f=n*o,l=n*u;n=n*a;var c=r*u;r=r*a;i=i*a;o=s*o;u=s*u;s=s*a;t[0]=1-(c+i);t[1]=l-s;t[2]=n+u;t[3]=0;t[4]=l+s;t[5]=1-(f+i);t[6]=r-o;t[7]=0;t[8]=n-u;t[9]=r+o;t[10]=1-(f+c);t[11]=0;t[12]=0;t[13]=0;t[14]=0;t[15]=1;return t};quat4.slerp=function(e,t,n,r){r||(r=e);var i=n;if(e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]<0)i=-1*n;r[0]=1-n*e[0]+i*t[0];r[1]=1-n*e[1]+i*t[1];r[2]=1-n*e[2]+i*t[2];r[3]=1-n*e[3]+i*t[3];return r};quat4.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+"]"};var QUARTZ={REVISION:"1"};var gl=null;QUARTZ.textures=new Array;QUARTZ.textureFiles=new Array;QUARTZ.models=new Array;QUARTZ.modelFiles=new Array;QUARTZ.lightsArray=new Array;QUARTZ.modelView=null;QUARTZ.root=null;QUARTZ.program=null;QUARTZ.getRoot=function(){if(QUARTZ.root==null){QUARTZ.root=new QUARTZ.Node;QUARTZ.root.entity=new QUARTZ.Scene}return QUARTZ.root};QUARTZ.pushMatrix=function(e){QUARTZ.modelView.push(e)};QUARTZ.popMatrix=function(){if(QUARTZ.modelView.length>0)QUARTZ.modelView.splice(QUARTZ.modelView.length-1,1)};QUARTZ.getMVMatrix=function(){if(QUARTZ.modelView.length>0)return QUARTZ.modelView[QUARTZ.modelView.length-1];else alert("modelView stack is empty");return null};QUARTZ.Node=function(){this.children=new Array;return this};QUARTZ.Node.prototype={constructor:QUARTZ.Node,entity:null,dad:null,children:new Array,setEntity:function(e){if(e instanceof QUARTZ.Entity){this.entity=e}return true},setDad:function(e){if(e instanceof QUARTZ.Node){this.dad=e}return true},addChild:function(e){if(e instanceof QUARTZ.Node){return this.children.push(e)}return-1},draw:function(){this.entity.beginDraw(this.children);this.entity.endDraw()},remHijoByIndex:function(e){this.children.splice(e,1)},remHijoByNode:function(e){for(var t in this.children){if(this.children[t]==e){this.children.splice(t,1)}}}};QUARTZ.Scene=function(){return this};QUARTZ.Scene.prototype={constructor:QUARTZ.Scene,beginDraw:function(e){for(var t=0;t<e.length;t++){e[t].draw()}},endDraw:function(){}};QUARTZ.Color=function(e,t,n,r){return this};QUARTZ.Color.prototype={constructor:QUARTZ.Color,color:null,r:1,g:1,b:1,a:1,setColor:function(e,t,n,r){r=typeof r!=="undefined"?r:1;this.r=e;this.g=t;this.b=n;this.a=r;color=vec4(e,t,n,r)}};QUARTZ.Light=function(e,t,n,r,i,s){null;null;null;null;null;null;null;this.setLight(e,t,n,r,i,s);return this};QUARTZ.Light.prototype={constructor:QUARTZ.Light,type:null,amb:null,dif:null,spec:null,position:null,direction:null,intensity:null,setAmbient:function(e){this.amb=e},setDiffuse:function(e){this.dif=e},setSpecular:function(e){this.spec=e},setDirection:function(e){this.direction=e},setPosition:function(e){this.position=e},setIntensity:function(e){this.intensity=e},setLight:function(e,t,n,r,i,s){this.setAmbient(e);this.setDiffuse(t);this.setSpecular(n);this.setDirection(r);this.setPosition(i);this.setIntensity(s)},beginDraw:function(e){for(var t=0;t<e.length;t++){e[t].draw()}},endDraw:function(){}};QUARTZ.Camera=function(){return this};QUARTZ.Camera.prototype={constructor:QUARTZ.Camera,background:QUARTZ.Color(1,1,1,1),near:1,far:10,setPerspective:function(e,t){this.near=e;this.far=t},setBackground:function(e,t,n,r){this.background=QUARTZ.Color(e,t,n,r)},beginDraw:function(e){for(var t=0;t<e.length;t++){e[t].draw()}},endDraw:function(){}};QUARTZ.Mesh=function(){this.vertices=new Float32Array;this.normals=new Float32Array;this.uvt=new Float32Array;this.ind=new Array;this.fileURL="";this.textureURL="";this.textureNum=null;this.texture=null;this.textureImg=null;this.color=[1,1,1,1];return this};QUARTZ.Mesh.prototype={constructor:QUARTZ.Mesh,vertices:null,normals:null,uvt:null,ind:null,fileURL:null,color:QUARTZ.Color("1","1","1"),setVertices:function(e){this.vertices=e},initTextures:function(e,t){if(QUARTZ.textures.indexOf(this.textureURL)<0){this.texture=e.createTexture();this.textureImg=new Image;this.textureImg.src=this.textureURL;this.textureImg.onload=function(){t.handleTextureLoaded(t.textureImg,t.texture)}}},handleTextureLoaded:function(e,t){gl.bindTexture(gl.TEXTURE_2D,t);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_NEAREST);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,e);gl.generateMipmap(gl.TEXTURE_2D);gl.bindTexture(gl.TEXTURE_2D,null);var n=e.src.split("/");if(QUARTZ.textures.indexOf(n[n.length-1])<0){QUARTZ.textures.push(n[n.length-1]);QUARTZ.textureFiles.push([e,t,n[n.length-1]])}this.textureNum=QUARTZ.textures.indexOf(this.textureImg.src)},setNormals:function(e){this.normals=e},setUvt:function(e){this.uvt=e},setIndexes:function(e){this.ind=e},initArrays:function(e,t){var n=null;var r=false;if(t.fileURL.search(".obj")>-1){if(QUARTZ.models.indexOf(t.fileURL)<0){QUARTZ.models.push(t.fileURL);n=K3D.parse.fromOBJ(e)}else{r=true;var i=QUARTZ.models.indexOf(t.fileURL);var s=QUARTZ.modelFiles[i];t.vertices=s[0];t.normals=s[1];t.uvt=s[2];t.ind=s[3]}}if(n!=null&&!r){t.vertices=new Float32Array(K3D.edit.unwrap(n.i_verts,n.c_verts,3));t.normals=new Float32Array(K3D.edit.unwrap(n.i_norms,n.c_norms,3));t.uvt=new Float32Array(K3D.edit.unwrap(n.i_uvt,n.c_uvt,2));var o=new Array;for(var u=0;u<n.i_verts.length;u++){o.push(u)}t.ind=new Int16Array(o);QUARTZ.modelFiles.push([t.vertices,t.normals,t.uvt,t.ind])}},loadModel:function(e){this.fileURL=e;K3D.load(this.fileURL,this.initArrays,this)},beginDraw:function(){var e;if(QUARTZ.program==null){e=gl.createProgram();var t=function(t,n){var r=gl.createShader(t=="vertex"?gl.VERTEX_SHADER:gl.FRAGMENT_SHADER);gl.shaderSource(r,n);gl.compileShader(r);if(!gl.getShaderParameter(r,gl.COMPILE_STATUS)){throw"Could not compile "+t+" shader:\n\n"+gl.getShaderInfoLog(r)}gl.attachShader(e,r)};t("vertex",QUARTZ.getVertexShader());t("fragment",QUARTZ.getFragmentShader());QUARTZ.program=e;gl.linkProgram(e);gl.useProgram(e)}else{e=QUARTZ.program}var n=mat4.create();mat4.perspective(45,QUARTZ.cwidth/QUARTZ.cheight,.1,1e4,n);var r=QUARTZ.getMVMatrix();e.aVertexPosition=gl.getAttribLocation(e,"aVertexPosition");e.aVertexNormal=gl.getAttribLocation(e,"aVertexNormal");e.aTextureCoord=gl.getAttribLocation(e,"aTextureCoord");e.uPMatrix=gl.getUniformLocation(e,"uPMatrix");e.uMVMatrix=gl.getUniformLocation(e,"uMVMatrix");e.uNMatrix=gl.getUniformLocation(e,"uNMatrix");e.uModelColor=gl.getUniformLocation(e,"uModelColor");var i=mat4.create();mat4.set(r,i);mat4.inverse(i);mat4.transpose(i);if(QUARTZ.lightsArray.length>0){e.uAmbientColor=gl.getUniformLocation(e,"uAmbientColor");var s=new Array;for(var o=0;o<QUARTZ.lightsArray.length;o++){s.push(QUARTZ.lightsArray[o].amb[0],QUARTZ.lightsArray[o].amb[1],QUARTZ.lightsArray[o].amb[2])}gl.uniform3fv(e.uAmbientColor,new Float32Array(s));e.uPointLightingColor=gl.getUniformLocation(e,"uPointLightingColor");var u=new Array;for(var o=0;o<QUARTZ.lightsArray.length;o++){u.push(QUARTZ.lightsArray[o].dif[0],QUARTZ.lightsArray[o].dif[1],QUARTZ.lightsArray[o].dif[2])}gl.uniform3fv(e.uPointLightingColor,new Float32Array(u));e.uPointLightingLocation=gl.getUniformLocation(e,"uPointLightingLocation");var a=new Array;for(var o=0;o<QUARTZ.lightsArray.length;o++){a.push(QUARTZ.lightsArray[o].position[0],QUARTZ.lightsArray[o].position[1],QUARTZ.lightsArray[o].position[2])}gl.uniform3fv(e.uPointLightingLocation,new Float32Array(a));e.uPointLightingIntensity=gl.getUniformLocation(e,"uPointLightingIntensity");var f=new Array;for(var o=0;o<QUARTZ.lightsArray.length;o++){f.push(QUARTZ.lightsArray[o].intensity)}gl.uniform1fv(e.uPointLightingIntensity,f);e.uSpecularFactor=gl.getUniformLocation(e,"uSpecularFactor");var l=new Array;for(var o=0;o<QUARTZ.lightsArray.length;o++){l.push(QUARTZ.lightsArray[o].spec)}gl.uniform1fv(e.uSpecularFactor,l)}gl.activeTexture(gl.TEXTURE1);gl.bindTexture(gl.TEXTURE_2D,this.texture);if(this.textureURL!=""){gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,this.texture);gl.uniform1i(gl.getUniformLocation(e,"uSampler"),0);gl.uniform1i(gl.getUniformLocation(e,"uUseTextures"),1);this.initTextures(gl,this)}else{gl.bindTexture(gl.TEXTURE_2D,this.texture);gl.uniform1i(gl.getUniformLocation(e,"uUseTextures"),0)}gl.enableVertexAttribArray(e.aVertexPosition);gl.enableVertexAttribArray(e.aVertexNormal);gl.enableVertexAttribArray(e.aTextureCoord);gl.uniform4fv(e.uModelColor,new Float32Array(this.color));gl.uniformMatrix4fv(e.uMVMatrix,false,r);gl.uniformMatrix4fv(e.uPMatrix,false,n);gl.uniformMatrix4fv(e.uNMatrix,false,i);if(!gl.getProgramParameter(e,gl.LINK_STATUS)){throw"Could not link the shader program!"}var c=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,c);gl.bufferData(gl.ARRAY_BUFFER,this.normals,gl.STATIC_DRAW);gl.vertexAttribPointer(e.aVertexNormal,3,gl.FLOAT,false,0,0);var h=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,h);gl.bufferData(gl.ARRAY_BUFFER,this.uvt,gl.STATIC_DRAW);gl.vertexAttribPointer(e.aTextureCoord,2,gl.FLOAT,false,0,0);var p=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,p);gl.bufferData(gl.ARRAY_BUFFER,this.vertices,gl.STATIC_DRAW);gl.vertexAttribPointer(e.aVertexPosition,3,gl.FLOAT,false,0,0);var d=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,d);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,this.ind,gl.STATIC_DRAW);gl.drawElements(gl.TRIANGLES,this.ind.length,gl.UNSIGNED_SHORT,0);gl.deleteBuffer(c);gl.deleteBuffer(h);gl.deleteBuffer(p);gl.deleteBuffer(d)},endDraw:function(){}};QUARTZ.Transf=function(){this.rot=new Array;this.tras=null;return this};QUARTZ.Transf.prototype={constructor:QUARTZ.Transf,tras:null,sca:null,identity:function(e){mat4.identity(e)},load:function(e,t){mat4.set(e,t)},transpose:function(e){mat4.transpose(e)},setTraslation:function(e,t,n){this.tras=[e,t,n]},traslate:function(e){if(this.tras!=null)mat4.translate(e,this.tras)},scale:function(e){if(this.sca!=null)mat4.scale(e,this.sca)},addRotation:function(e,t){if(this.rot==null){this.rot=new Array(2);this.rot.push([e,t])}else this.rot.push([e,t])},rotate:function(e){var t=mat4.create();for(var n=0;n<this.rot.length;n++){var r=this.rot[n][0];var i=this.rot[n][1];t=e;mat4.rotate(t,r*Math.PI/180,i)}t=e;return t},setScale:function(e,t,n){if(typeof t!=="undefined"){this.sca=[e,t,n]}else{this.sca=[e,e,e]}},beginDraw:function(e){mv=new Float32Array(QUARTZ.getMVMatrix());this.traslate(mv);mv=this.rotate(mv);this.scale(mv);QUARTZ.pushMatrix(mv);for(var t=0;t<e.length;t++){e[t].draw()}},endDraw:function(){QUARTZ.popMatrix()}};var gl;QUARTZ.createMesh=function(){var e=new QUARTZ.Mesh;return e};QUARTZ.createLight=function(){var e=new QUARTZ.Light;return e};QUARTZ.createTransform=function(){var e=new QUARTZ.Transf;return e};QUARTZ.addMesh=function(e,t){if(t instanceof QUARTZ.Node){if(e instanceof QUARTZ.Mesh){var n=new QUARTZ.Node;n.entity=e;t.addChild(n);return n}else alert("There was a problem when adding mesh. It's not a Mesh.")}else alert("There was a problem when adding mesh. Parent is not a Node.")};QUARTZ.addTransform=function(e,t){if(t instanceof QUARTZ.Node){if(e instanceof QUARTZ.Transf){var n=new QUARTZ.Node;n.entity=e;t.addChild(n);return n}else alert("There was a problem when adding a tranformation. It's not a Transformation.")}else alert("There was a problem when adding transformation. Parent is not a Node.")};QUARTZ.addLight=function(e,t){if(t instanceof QUARTZ.Node){if(e instanceof QUARTZ.Light){QUARTZ.lightsArray.push(e);var n=new QUARTZ.Node;n.entity=e;return n}else alert("There was a problem when adding light "+(QUARTZ.lightsArray.length+1)+". It's not a light.")}else alert("There was a problem when adding light "+(QUARTZ.lightsArray.length+1)+". Parent is not a Node.")};QUARTZ.getVertexShader=function(){var e="";if(QUARTZ.lightsArray.length>0)e+="const int numLights = "+QUARTZ.lightsArray.length+";";else e+="const int numLights = 1;";e+="attribute vec3 aVertexNormal;";e+="attribute vec3 aVertexPosition;";e+="attribute vec2 aTextureCoord;";e+="attribute vec3 aVertexColor;";e+="uniform highp mat4 uMVMatrix;";e+="uniform highp mat4 uPMatrix;";e+="uniform highp mat4 uNMatrix;";e+="uniform mediump vec4 uModelColor;";e+="uniform mediump vec3 uAmbientColor[numLights];";e+="uniform mediump vec3 uPointLightingLocation[numLights];";e+="uniform mediump vec3 uPointLightingColor[numLights];";e+="uniform mediump float uniformPointLightingIntensity[numLights];";e+="uniform mediump float uSpecularFactor[numLights];";e+="uniform sampler2D uSampler;";e+="varying vec3 vColor;";e+="varying vec4 mvPosition;";e+="varying mediump vec4 transformedNormal;";e+="varying vec2 vTextureCoord;";e+="void main(void) {";e+="	  mvPosition = uMVMatrix * vec4(aVertexPosition,1.0);";e+="	  gl_Position = uPMatrix * mvPosition;";e+="    transformedNormal =  normalize(uNMatrix * vec4(aVertexNormal, 1.0));";e+="	  vTextureCoord = aTextureCoord;";e+="    vColor = vec3(1,1,1);";e+="}";return e};QUARTZ.getFragmentShader=function(){var e="";if(QUARTZ.lightsArray.length>0)e+="const int numLights = "+QUARTZ.lightsArray.length+";";else e+="const int numLights = 1;";e+="varying mediump vec3 vColor;";e+="mediump vec3 vLightWeighting;";e+="varying highp vec4 mvPosition;";e+="varying mediump vec4 transformedNormal;";e+="varying mediump vec2 vTextureCoord;";e+="uniform bool uUseTextures;";e+="uniform highp mat4 uMVMatrix;";e+="uniform highp mat4 uPMatrix;";e+="uniform highp mat4 uNMatrix;";e+="uniform mediump vec4 uModelColor;";e+="uniform mediump vec3 uAmbientColor[numLights];";e+="uniform mediump vec3 uPointLightingLocation[numLights];";e+="uniform mediump vec3 uPointLightingColor[numLights];";e+="uniform mediump float uPointLightingIntensity[numLights];";e+="uniform mediump float uSpecularFactor[numLights];";e+="uniform sampler2D uSampler;";e+="mediump vec4 fragmentColor;";e+="void main(void) {";if(QUARTZ.lightsArray.length>0){e+="for (int i = 0; i < numLights; i++) {";e+="    mediump vec3 lightDirection = normalize(mvPosition.xyz-uPointLightingLocation[i]);";e+="    mediump float lightDistance = length(uPointLightingLocation[i] - mvPosition.xyz);";e+="	  if(lightDistance < 0.0){lightDistance = lightDistance * - 1.0;}";e+="	  lightDistance = (1000.0-lightDistance) / 1000.0;";e+="    mediump float directionalLightWeighting = max(dot(transformedNormal.xyz, lightDirection), 0.0);";e+="    if(i==0){";e+="    	vLightWeighting  =  uAmbientColor[i] + uPointLightingColor[i] * lightDistance * directionalLightWeighting;";e+="    }";e+="	  else vLightWeighting = vLightWeighting + (uAmbientColor[i] + uPointLightingColor[i] * lightDistance * directionalLightWeighting);";e+="	   mediump vec3 E = normalize(-mvPosition.xyz);";e+="	   mediump vec3 R = reflect(lightDirection, transformedNormal.xyz);";e+="	  mediump float specular = pow( max(dot(R, E), 0.0), uSpecularFactor[i]);";e+="    vLightWeighting = vLightWeighting + uPointLightingColor[i] * specular;";e+="	  }";e+="	  if (uUseTextures) {";e+="		fragmentColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));";e+="	  }";e+="	  else fragmentColor = vec4(uModelColor);";e+="    gl_FragColor = vec4(fragmentColor.rgb * vLightWeighting, fragmentColor.a);"}else{e+="	  if (uUseTextures) {";e+="		fragmentColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));";e+="	  }";e+="	  else{";e+="	  fragmentColor = vec4(uModelColor);}";e+="	  gl_FragColor = fragmentColor;"}e+="}";return e};QUARTZ.start=function(e){var t=document.getElementById(e);gl=initWebGL(t);if(gl){gl.clearColor(0,0,0,1);gl.enable(gl.DEPTH_TEST);gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.depthFunc(gl.LEQUAL);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);QUARTZ.cwidth=t.width;QUARTZ.cheight=t.height;gl.viewport(0,0,t.width,t.height)}};QUARTZ.init=function(e){QUARTZ.start(e);QUARTZ.draw()};QUARTZ.draw=function(e,t,n){if(typeof e!==undefined)gl.clearColor(e,t,n,1);else gl.clearColor(0,0,0,1);gl.enable(gl.DEPTH_TEST);gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.depthFunc(gl.LEQUAL);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);var r=mat4.create();mat4.identity(r);QUARTZ.modelView=new Array;QUARTZ.modelView.push(r);QUARTZ.getRoot().draw()}