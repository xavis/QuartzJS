glMatrixArrayType=typeof Float32Array!="undefined"?Float32Array:typeof WebGLFloatArray!="undefined"?WebGLFloatArray:Array;var vec3={};vec3.create=function(a){var b=new glMatrixArrayType(3);if(a){b[0]=a[0];b[1]=a[1];b[2]=a[2]}return b};vec3.set=function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];return b};vec3.add=function(a,b,c){if(!c||a==c){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2];return a}c[0]=a[0]+b[0];c[1]=a[1]+b[1];c[2]=a[2]+b[2];return c};vec3.subtract=function(a,b,c){if(!c||a==c){a[0]-=b[0];a[1]-=b[1];a[2]-=b[2];return a}c[0]=a[0]-b[0];c[1]=a[1]-b[1];c[2]=a[2]-b[2];return c};vec3.negate=function(a,b){b||(b=a);b[0]=-a[0];b[1]=-a[1];b[2]=-a[2];return b};vec3.scale=function(a,b,c){if(!c||a==c){a[0]*=b;a[1]*=b;a[2]*=b;return a}c[0]=a[0]*b;c[1]=a[1]*b;c[2]=a[2]*b;return c};vec3.normalize=function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],g=Math.sqrt(c*c+d*d+e*e);if(g){if(g==1){b[0]=c;b[1]=d;b[2]=e;return b}}else{b[0]=0;b[1]=0;b[2]=0;return b}g=1/g;b[0]=c*g;b[1]=d*g;b[2]=e*g;return b};vec3.cross=function(a,b,c){c||(c=a);var d=a[0],e=a[1];a=a[2];var g=b[0],f=b[1];b=b[2];c[0]=e*b-a*f;c[1]=a*g-d*b;c[2]=d*f-e*g;return c};vec3.length=function(a){var b=a[0],c=a[1];a=a[2];return Math.sqrt(b*b+c*c+a*a)};vec3.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]};vec3.direction=function(a,b,c){c||(c=a);var d=a[0]-b[0],e=a[1]-b[1];a=a[2]-b[2];b=Math.sqrt(d*d+e*e+a*a);if(!b){c[0]=0;c[1]=0;c[2]=0;return c}b=1/b;c[0]=d*b;c[1]=e*b;c[2]=a*b;return c};vec3.lerp=function(a,b,c,d){d||(d=a);d[0]=a[0]+c*(b[0]-a[0]);d[1]=a[1]+c*(b[1]-a[1]);d[2]=a[2]+c*(b[2]-a[2]);return d};vec3.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+"]"};var mat3={};mat3.create=function(a){var b=new glMatrixArrayType(9);if(a){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9]}return b};mat3.set=function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];return b};mat3.identity=function(a){a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=1;a[5]=0;a[6]=0;a[7]=0;a[8]=1;return a};mat3.transpose=function(a,b){if(!b||a==b){var c=a[1],d=a[2],e=a[5];a[1]=a[3];a[2]=a[6];a[3]=c;a[5]=a[7];a[6]=d;a[7]=e;return a}b[0]=a[0];b[1]=a[3];b[2]=a[6];b[3]=a[1];b[4]=a[4];b[5]=a[7];b[6]=a[2];b[7]=a[5];b[8]=a[8];return b};mat3.toMat4=function(a,b){b||(b=mat4.create());b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=0;b[4]=a[3];b[5]=a[4];b[6]=a[5];b[7]=0;b[8]=a[6];b[9]=a[7];b[10]=a[8];b[11]=0;b[12]=0;b[13]=0;b[14]=0;b[15]=1;return b};mat3.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+"]"};var mat4={};mat4.create=function(a){var b=new glMatrixArrayType(16);if(a){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15]}return b};mat4.set=function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15];return b};mat4.identity=function(a){a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a};mat4.transpose=function(a,b){if(!b||a==b){var c=a[1],d=a[2],e=a[3],g=a[6],f=a[7],h=a[11];a[1]=a[4];a[2]=a[8];a[3]=a[12];a[4]=c;a[6]=a[9];a[7]=a[13];a[8]=d;a[9]=g;a[11]=a[14];a[12]=e;a[13]=f;a[14]=h;return a}b[0]=a[0];b[1]=a[4];b[2]=a[8];b[3]=a[12];b[4]=a[1];b[5]=a[5];b[6]=a[9];b[7]=a[13];b[8]=a[2];b[9]=a[6];b[10]=a[10];b[11]=a[14];b[12]=a[3];b[13]=a[7];b[14]=a[11];b[15]=a[15];return b};mat4.determinant=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],g=a[4],f=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],o=a[11],m=a[12],n=a[13],p=a[14];a=a[15];return m*k*h*e-j*n*h*e-m*f*l*e+g*n*l*e+j*f*p*e-g*k*p*e-m*k*d*i+j*n*d*i+m*c*l*i-b*n*l*i-j*c*p*i+b*k*p*i+m*f*d*o-g*n*d*o-m*c*h*o+b*n*h*o+g*c*p*o-b*f*p*o-j*f*d*a+g*k*d*a+j*c*h*a-b*k*h*a-g*c*l*a+b*f*l*a};mat4.inverse=function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],g=a[3],f=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],o=a[10],m=a[11],n=a[12],p=a[13],r=a[14],s=a[15],A=c*h-d*f,B=c*i-e*f,t=c*j-g*f,u=d*i-e*h,v=d*j-g*h,w=e*j-g*i,x=k*p-l*n,y=k*r-o*n,z=k*s-m*n,C=l*r-o*p,D=l*s-m*p,E=o*s-m*r,q=1/(A*E-B*D+t*C+u*z-v*y+w*x);b[0]=(h*E-i*D+j*C)*q;b[1]=(-d*E+e*D-g*C)*q;b[2]=(p*w-r*v+s*u)*q;b[3]=(-l*w+o*v-m*u)*q;b[4]=(-f*E+i*z-j*y)*q;b[5]=(c*E-e*z+g*y)*q;b[6]=(-n*w+r*t-s*B)*q;b[7]=(k*w-o*t+m*B)*q;b[8]=(f*D-h*z+j*x)*q;b[9]=(-c*D+d*z-g*x)*q;b[10]=(n*v-p*t+s*A)*q;b[11]=(-k*v+l*t-m*A)*q;b[12]=(-f*C+h*y-i*x)*q;b[13]=(c*C-d*y+e*x)*q;b[14]=(-n*u+p*B-r*A)*q;b[15]=(k*u-l*B+o*A)*q;return b};mat4.toRotationMat=function(a,b){b||(b=mat4.create());b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=0;b[13]=0;b[14]=0;b[15]=1;return b};mat4.toMat3=function(a,b){b||(b=mat3.create());b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[4];b[4]=a[5];b[5]=a[6];b[6]=a[8];b[7]=a[9];b[8]=a[10];return b};mat4.toInverseMat3=function(a,b){var c=a[0],d=a[1],e=a[2],g=a[4],f=a[5],h=a[6],i=a[8],j=a[9],k=a[10],l=k*f-h*j,o=-k*g+h*i,m=j*g-f*i,n=c*l+d*o+e*m;if(!n)return null;n=1/n;b||(b=mat3.create());b[0]=l*n;b[1]=(-k*d+e*j)*n;b[2]=(h*d-e*f)*n;b[3]=o*n;b[4]=(k*c-e*i)*n;b[5]=(-h*c+e*g)*n;b[6]=m*n;b[7]=(-j*c+d*i)*n;b[8]=(f*c-d*g)*n;return b};mat4.multiply=function(a,b,c){c||(c=a);var d=a[0],e=a[1],g=a[2],f=a[3],h=a[4],i=a[5],j=a[6],k=a[7],l=a[8],o=a[9],m=a[10],n=a[11],p=a[12],r=a[13],s=a[14];a=a[15];var A=b[0],B=b[1],t=b[2],u=b[3],v=b[4],w=b[5],x=b[6],y=b[7],z=b[8],C=b[9],D=b[10],E=b[11],q=b[12],F=b[13],G=b[14];b=b[15];c[0]=A*d+B*h+t*l+u*p;c[1]=A*e+B*i+t*o+u*r;c[2]=A*g+B*j+t*m+u*s;c[3]=A*f+B*k+t*n+u*a;c[4]=v*d+w*h+x*l+y*p;c[5]=v*e+w*i+x*o+y*r;c[6]=v*g+w*j+x*m+y*s;c[7]=v*f+w*k+x*n+y*a;c[8]=z*d+C*h+D*l+E*p;c[9]=z*e+C*i+D*o+E*r;c[10]=z*g+C*j+D*m+E*s;c[11]=z*f+C*k+D*n+E*a;c[12]=q*d+F*h+G*l+b*p;c[13]=q*e+F*i+G*o+b*r;c[14]=q*g+F*j+G*m+b*s;c[15]=q*f+F*k+G*n+b*a;return c};mat4.multiplyVec3=function(a,b,c){c||(c=b);var d=b[0],e=b[1];b=b[2];c[0]=a[0]*d+a[4]*e+a[8]*b+a[12];c[1]=a[1]*d+a[5]*e+a[9]*b+a[13];c[2]=a[2]*d+a[6]*e+a[10]*b+a[14];return c};mat4.multiplyVec4=function(a,b,c){c||(c=b);var d=b[0],e=b[1],g=b[2];b=b[3];c[0]=a[0]*d+a[4]*e+a[8]*g+a[12]*b;c[1]=a[1]*d+a[5]*e+a[9]*g+a[13]*b;c[2]=a[2]*d+a[6]*e+a[10]*g+a[14]*b;c[3]=a[3]*d+a[7]*e+a[11]*g+a[15]*b;return c};mat4.translate=function(a,b,c){var d=b[0],e=b[1];b=b[2];if(!c||a==c){a[12]=a[0]*d+a[4]*e+a[8]*b+a[12];a[13]=a[1]*d+a[5]*e+a[9]*b+a[13];a[14]=a[2]*d+a[6]*e+a[10]*b+a[14];a[15]=a[3]*d+a[7]*e+a[11]*b+a[15];return a}var g=a[0],f=a[1],h=a[2],i=a[3],j=a[4],k=a[5],l=a[6],o=a[7],m=a[8],n=a[9],p=a[10],r=a[11];c[0]=g;c[1]=f;c[2]=h;c[3]=i;c[4]=j;c[5]=k;c[6]=l;c[7]=o;c[8]=m;c[9]=n;c[10]=p;c[11]=r;c[12]=g*d+j*e+m*b+a[12];c[13]=f*d+k*e+n*b+a[13];c[14]=h*d+l*e+p*b+a[14];c[15]=i*d+o*e+r*b+a[15];return c};mat4.scale=function(a,b,c){var d=b[0],e=b[1];b=b[2];if(!c||a==c){a[0]*=d;a[1]*=d;a[2]*=d;a[3]*=d;a[4]*=e;a[5]*=e;a[6]*=e;a[7]*=e;a[8]*=b;a[9]*=b;a[10]*=b;a[11]*=b;return a}c[0]=a[0]*d;c[1]=a[1]*d;c[2]=a[2]*d;c[3]=a[3]*d;c[4]=a[4]*e;c[5]=a[5]*e;c[6]=a[6]*e;c[7]=a[7]*e;c[8]=a[8]*b;c[9]=a[9]*b;c[10]=a[10]*b;c[11]=a[11]*b;c[12]=a[12];c[13]=a[13];c[14]=a[14];c[15]=a[15];return c};mat4.rotate=function(a,b,c,d){var e=c[0],g=c[1];c=c[2];var f=Math.sqrt(e*e+g*g+c*c);if(!f)return null;if(f!=1){f=1/f;e*=f;g*=f;c*=f}var h=Math.sin(b),i=Math.cos(b),j=1-i;b=a[0];f=a[1];var k=a[2],l=a[3],o=a[4],m=a[5],n=a[6],p=a[7],r=a[8],s=a[9],A=a[10],B=a[11],t=e*e*j+i,u=g*e*j+c*h,v=c*e*j-g*h,w=e*g*j-c*h,x=g*g*j+i,y=c*g*j+e*h,z=e*c*j+g*h;e=g*c*j-e*h;g=c*c*j+i;if(d){if(a!=d){d[12]=a[12];d[13]=a[13];d[14]=a[14];d[15]=a[15]}}else d=a;d[0]=b*t+o*u+r*v;d[1]=f*t+m*u+s*v;d[2]=k*t+n*u+A*v;d[3]=l*t+p*u+B*v;d[4]=b*w+o*x+r*y;d[5]=f*w+m*x+s*y;d[6]=k*w+n*x+A*y;d[7]=l*w+p*x+B*y;d[8]=b*z+o*e+r*g;d[9]=f*z+m*e+s*g;d[10]=k*z+n*e+A*g;d[11]=l*z+p*e+B*g;return d};mat4.rotateX=function(a,b,c){var d=Math.sin(b);b=Math.cos(b);var e=a[4],g=a[5],f=a[6],h=a[7],i=a[8],j=a[9],k=a[10],l=a[11];if(c){if(a!=c){c[0]=a[0];c[1]=a[1];c[2]=a[2];c[3]=a[3];c[12]=a[12];c[13]=a[13];c[14]=a[14];c[15]=a[15]}}else c=a;c[4]=e*b+i*d;c[5]=g*b+j*d;c[6]=f*b+k*d;c[7]=h*b+l*d;c[8]=e*-d+i*b;c[9]=g*-d+j*b;c[10]=f*-d+k*b;c[11]=h*-d+l*b;return c};mat4.rotateY=function(a,b,c){var d=Math.sin(b);b=Math.cos(b);var e=a[0],g=a[1],f=a[2],h=a[3],i=a[8],j=a[9],k=a[10],l=a[11];if(c){if(a!=c){c[4]=a[4];c[5]=a[5];c[6]=a[6];c[7]=a[7];c[12]=a[12];c[13]=a[13];c[14]=a[14];c[15]=a[15]}}else c=a;c[0]=e*b+i*-d;c[1]=g*b+j*-d;c[2]=f*b+k*-d;c[3]=h*b+l*-d;c[8]=e*d+i*b;c[9]=g*d+j*b;c[10]=f*d+k*b;c[11]=h*d+l*b;return c};mat4.rotateZ=function(a,b,c){var d=Math.sin(b);b=Math.cos(b);var e=a[0],g=a[1],f=a[2],h=a[3],i=a[4],j=a[5],k=a[6],l=a[7];if(c){if(a!=c){c[8]=a[8];c[9]=a[9];c[10]=a[10];c[11]=a[11];c[12]=a[12];c[13]=a[13];c[14]=a[14];c[15]=a[15]}}else c=a;c[0]=e*b+i*d;c[1]=g*b+j*d;c[2]=f*b+k*d;c[3]=h*b+l*d;c[4]=e*-d+i*b;c[5]=g*-d+j*b;c[6]=f*-d+k*b;c[7]=h*-d+l*b;return c};mat4.frustum=function(a,b,c,d,e,g,f){f||(f=mat4.create());var h=b-a,i=d-c,j=g-e;f[0]=e*2/h;f[1]=0;f[2]=0;f[3]=0;f[4]=0;f[5]=e*2/i;f[6]=0;f[7]=0;f[8]=(b+a)/h;f[9]=(d+c)/i;f[10]=-(g+e)/j;f[11]=-1;f[12]=0;f[13]=0;f[14]=-(g*e*2)/j;f[15]=0;return f};mat4.perspective=function(a,b,c,d,e){a=c*Math.tan(a*Math.PI/360);b=a*b;return mat4.frustum(-b,b,-a,a,c,d,e)};mat4.ortho=function(a,b,c,d,e,g,f){f||(f=mat4.create());var h=b-a,i=d-c,j=g-e;f[0]=2/h;f[1]=0;f[2]=0;f[3]=0;f[4]=0;f[5]=2/i;f[6]=0;f[7]=0;f[8]=0;f[9]=0;f[10]=-2/j;f[11]=0;f[12]=-(a+b)/h;f[13]=-(d+c)/i;f[14]=-(g+e)/j;f[15]=1;return f};mat4.lookAt=function(a,b,c,d){d||(d=mat4.create());var e=a[0],g=a[1];a=a[2];var f=c[0],h=c[1],i=c[2];c=b[1];var j=b[2];if(e==b[0]&&g==c&&a==j)return mat4.identity(d);var k,l,o,m;c=e-b[0];j=g-b[1];b=a-b[2];m=1/Math.sqrt(c*c+j*j+b*b);c*=m;j*=m;b*=m;k=h*b-i*j;i=i*c-f*b;f=f*j-h*c;if(m=Math.sqrt(k*k+i*i+f*f)){m=1/m;k*=m;i*=m;f*=m}else f=i=k=0;h=j*f-b*i;l=b*k-c*f;o=c*i-j*k;if(m=Math.sqrt(h*h+l*l+o*o)){m=1/m;h*=m;l*=m;o*=m}else o=l=h=0;d[0]=k;d[1]=h;d[2]=c;d[3]=0;d[4]=i;d[5]=l;d[6]=j;d[7]=0;d[8]=f;d[9]=o;d[10]=b;d[11]=0;d[12]=-(k*e+i*g+f*a);d[13]=-(h*e+l*g+o*a);d[14]=-(c*e+j*g+b*a);d[15]=1;return d};mat4.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+"]"};quat4={};quat4.create=function(a){var b=new glMatrixArrayType(4);if(a){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3]}return b};quat4.set=function(a,b){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return b};quat4.calculateW=function(a,b){var c=a[0],d=a[1],e=a[2];if(!b||a==b){a[3]=-Math.sqrt(Math.abs(1-c*c-d*d-e*e));return a}b[0]=c;b[1]=d;b[2]=e;b[3]=-Math.sqrt(Math.abs(1-c*c-d*d-e*e));return b};quat4.inverse=function(a,b){if(!b||a==b){a[0]*=1;a[1]*=1;a[2]*=1;return a}b[0]=-a[0];b[1]=-a[1];b[2]=-a[2];b[3]=a[3];return b};quat4.length=function(a){var b=a[0],c=a[1],d=a[2];a=a[3];return Math.sqrt(b*b+c*c+d*d+a*a)};quat4.normalize=function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],g=a[3],f=Math.sqrt(c*c+d*d+e*e+g*g);if(f==0){b[0]=0;b[1]=0;b[2]=0;b[3]=0;return b}f=1/f;b[0]=c*f;b[1]=d*f;b[2]=e*f;b[3]=g*f;return b};quat4.multiply=function(a,b,c){c||(c=a);var d=a[0],e=a[1],g=a[2];a=a[3];var f=b[0],h=b[1],i=b[2];b=b[3];c[0]=d*b+a*f+e*i-g*h;c[1]=e*b+a*h+g*f-d*i;c[2]=g*b+a*i+d*h-e*f;c[3]=a*b-d*f-e*h-g*i;return c};quat4.multiplyVec3=function(a,b,c){c||(c=b);var d=b[0],e=b[1],g=b[2];b=a[0];var f=a[1],h=a[2];a=a[3];var i=a*d+f*g-h*e,j=a*e+h*d-b*g,k=a*g+b*e-f*d;d=-b*d-f*e-h*g;c[0]=i*a+d*-b+j*-h-k*-f;c[1]=j*a+d*-f+k*-b-i*-h;c[2]=k*a+d*-h+i*-f-j*-b;return c};quat4.toMat3=function(a,b){b||(b=mat3.create());var c=a[0],d=a[1],e=a[2],g=a[3],f=c+c,h=d+d,i=e+e,j=c*f,k=c*h;c=c*i;var l=d*h;d=d*i;e=e*i;f=g*f;h=g*h;g=g*i;b[0]=1-(l+e);b[1]=k-g;b[2]=c+h;b[3]=k+g;b[4]=1-(j+e);b[5]=d-f;b[6]=c-h;b[7]=d+f;b[8]=1-(j+l);return b};quat4.toMat4=function(a,b){b||(b=mat4.create());var c=a[0],d=a[1],e=a[2],g=a[3],f=c+c,h=d+d,i=e+e,j=c*f,k=c*h;c=c*i;var l=d*h;d=d*i;e=e*i;f=g*f;h=g*h;g=g*i;b[0]=1-(l+e);b[1]=k-g;b[2]=c+h;b[3]=0;b[4]=k+g;b[5]=1-(j+e);b[6]=d-f;b[7]=0;b[8]=c-h;b[9]=d+f;b[10]=1-(j+l);b[11]=0;b[12]=0;b[13]=0;b[14]=0;b[15]=1;return b};quat4.slerp=function(a,b,c,d){d||(d=a);var e=c;if(a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]<0)e=-1*c;d[0]=1-c*a[0]+e*b[0];d[1]=1-c*a[1]+e*b[1];d[2]=1-c*a[2]+e*b[2];d[3]=1-c*a[3]+e*b[3];return d};quat4.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+"]"};var K3D={};K3D.load=function(path,resp,mesh){var request=new XMLHttpRequest();request.open("GET",path,true);request.responseType="arraybuffer";request.onload=function(e){resp(e.target.response,mesh)};request.send()}K3D.save=function(buff,path){var dataURI="data:application/octet-stream;base64,"+btoa(K3D.parse._buffToStr(buff));window.location.href=dataURI}K3D.clone=function(o){return JSON.parse(JSON.stringify(o))}K3D.bin={};K3D.bin.f=new Float32Array(1);K3D.bin.fb=new Uint8Array(K3D.bin.f.buffer);K3D.bin.rf=function(buff,off){var f=K3D.bin.f,fb=K3D.bin.fb;for(var i=0;i<4;i++)fb[i]=buff[off+i];return f[0]}K3D.bin.rsl=function(buff,off){return buff[off]|buff[off+1]<<8}K3D.bin.ril=function(buff,off){return buff[off]|buff[off+1]<<8|buff[off+2]<<16|buff[off+3]<<24}K3D.bin.rASCII0=function(buff,off){var s="";while(buff[off]!=0)s+=String.fromCharCode(buff[off++]);return s}K3D.bin.wf=function(buff,off,v){var f=new Float32Array(buff.buffer,off,1);f[0]=v}K3D.bin.wsl=function(buff,off,v){buff[off]=v;buff[off+1]=v>>8}K3D.bin.wil=function(buff,off,v){buff[off]=v;buff[off+1]=v>>8;buff[off+2]=v>>16;buff[off+3]>>24}K3D.parse={};K3D.parse._buffToStr=function(buff){var a=new Uint8Array(buff);var s="";for(var i=0;i<a.length;i++)s=s.concat(String.fromCharCode(a[i]));return s}K3D.parse._strToBuff=function(str){var buf=new ArrayBuffer(str.length);var bufView=new Uint8Array(buf);for(var i=0;i<str.length;i++)bufView[i]=str.charCodeAt(i);return buf}K3D.parse._readLine=function(a,off){var s="";while(a[off]!=10)s+=String.fromCharCode(a[off++]);return s}K3D.parse.fromJSON=function(buff){var json=JSON.parse(K3D.parse._buffToStr(buff));return json}K3D.parse.toJSON=function(object){var str=JSON.stringify(object);return K3D.parse._strToBuff(str)}K3D.parse.fromOBJ=function(buff){var res={};res.groups={};res.c_verts=[];res.c_uvt=[];res.c_norms=[];res.i_verts=[];res.i_uvt=[];res.i_norms=[];var cg={from:0,to:0};var off=0;var a=new Uint8Array(buff);while(off<a.length){var line=K3D.parse._readLine(a,off);off+=line.length+1;line=line.replace(/ +(?= )/g,'');line=line.replace(/(^\s+|\s+$)/g,'');var cds=line.split(" ");if(cds[0]=="g"){cg.to=res.i_verts.length;if(res.groups[cds[1]]==null)res.groups[cds[1]]={from:res.i_verts.length,to:0};cg=res.groups[cds[1]]}if(cds[0]=="v"){var x=parseFloat(cds[1]);var y=parseFloat(cds[2]);var z=parseFloat(cds[3]);res.c_verts.push(x,y,z)}if(cds[0]=="vt"){var x=parseFloat(cds[1]);var y=1-parseFloat(cds[2]);res.c_uvt.push(x,y)}if(cds[0]=="vn"){var x=parseFloat(cds[1]);var y=parseFloat(cds[2]);var z=parseFloat(cds[3]);res.c_norms.push(x,y,z)}if(cds[0]=="f"){var v0a=cds[1].split("/"),v1a=cds[2].split("/"),v2a=cds[3].split("/");var vi0=parseInt(v0a[0])-1,vi1=parseInt(v1a[0])-1,vi2=parseInt(v2a[0])-1;var ui0=parseInt(v0a[1])-1,ui1=parseInt(v1a[1])-1,ui2=parseInt(v2a[1])-1;var ni0=parseInt(v0a[2])-1,ni1=parseInt(v1a[2])-1,ni2=parseInt(v2a[2])-1;var vlen=res.c_verts.length/3,ulen=res.c_uvt.length/2,nlen=res.c_norms.length/3;if(vi0<0)vi0=vlen+vi0+1;if(vi1<0)vi1=vlen+vi1+1;if(vi2<0)vi2=vlen+vi2+1;if(ui0<0)ui0=ulen+ui0+1;if(ui1<0)ui1=ulen+ui1+1;if(ui2<0)ui2=ulen+ui2+1;if(ni0<0)ni0=nlen+ni0+1;if(ni1<0)ni1=nlen+ni1+1;if(ni2<0)ni2=nlen+ni2+1;res.i_verts.push(vi0,vi1,vi2);res.i_uvt.push(ui0,ui1,ui2);res.i_norms.push(ni0,ni1,ni2);if(cds.length==5){var v3a=cds[4].split("/");var vi3=parseInt(v3a[0])-1,ui3=parseInt(v3a[1])-1,ni3=parseInt(v3a[2])-1;if(vi3<0)vi3=vlen+vi3+1;if(ui3<0)ui3=ulen+ui3+1;if(ni3<0)ni3=nlen+ni3+1;res.i_verts.push(vi0,vi2,vi3);res.i_uvt.push(ui0,ui2,ui3);res.i_norms.push(ni0,ni2,ni3)}}}cg.to=res.i_verts.length;return res}K3D.parse.fromMD2=function(buff){buff=new Uint8Array(buff);var res={};var head={};head.ident=K3D.bin.ril(buff,0);head.version=K3D.bin.ril(buff,4);head.skinwidth=K3D.bin.ril(buff,8);head.skinheight=K3D.bin.ril(buff,12);head.framesize=K3D.bin.ril(buff,16);head.num_skins=K3D.bin.ril(buff,20);head.num_vertices=K3D.bin.ril(buff,24);head.num_st=K3D.bin.ril(buff,28);head.num_tris=K3D.bin.ril(buff,32);head.num_glcmds=K3D.bin.ril(buff,36);head.num_frames=K3D.bin.ril(buff,40);head.offset_skins=K3D.bin.ril(buff,44);head.offset_st=K3D.bin.ril(buff,48);head.offset_tris=K3D.bin.ril(buff,52);head.offset_frames=K3D.bin.ril(buff,56);head.offset_glcmds=K3D.bin.ril(buff,60);head.offset_end=K3D.bin.ril(buff,64);var off=head.offset_st;res.c_uvt=[];for(var i=0;i<head.num_st;i++){var x=K3D.bin.rsl(buff,off)/head.skinwidth;var y=K3D.bin.rsl(buff,off+2)/head.skinheight;res.c_uvt.push(x,y);off+=4}var off=head.offset_tris;var vi=[],ti=[];res.i_verts=vi;res.i_uvt=ti;for(var i=0;i<head.num_tris;i++){vi.push(K3D.bin.rsl(buff,off),K3D.bin.rsl(buff,off+2),K3D.bin.rsl(buff,off+4));ti.push(K3D.bin.rsl(buff,off+6),K3D.bin.rsl(buff,off+8),K3D.bin.rsl(buff,off+10));off+=12}var off=head.offset_skins;res.skins=[];for(var i=0;i<head.num_skins;i++){res.skins.push(K3D.bin.rASCII0(buff,off));off+=64}var off=head.offset_frames;res.frames=[];var nms=K3D.parse.fromMD2._normals;for(var i=0;i<head.num_frames;i++){var fr={};var sx=K3D.bin.rf(buff,off),sy=K3D.bin.rf(buff,off+4),sz=K3D.bin.rf(buff,off+8);off+=12;var tx=K3D.bin.rf(buff,off),ty=K3D.bin.rf(buff,off+4),tz=K3D.bin.rf(buff,off+8);off+=12;fr.name=K3D.bin.rASCII0(buff,off);off+=16;fr.verts=[];fr.norms=[];for(var j=0;j<head.num_vertices;j++){fr.verts.push(buff[off]*sx+tx,buff[off+1]*sy+ty,buff[off+2]*sz+tz);fr.norms.push(nms[3*buff[off+3]],nms[3*buff[off+3]+1],nms[3*buff[off+3]+2]);off+=4}res.frames.push(fr)}return res}K3D.parse.fromMD2._normals=[-0.525731,0.000000,0.850651,-0.442863,0.238856,0.864188,-0.295242,0.000000,0.955423,-0.309017,0.500000,0.809017,-0.162460,0.262866,0.951056,0.000000,0.000000,1.000000,0.000000,0.850651,0.525731,-0.147621,0.716567,0.681718,0.147621,0.716567,0.681718,0.000000,0.525731,0.850651,0.309017,0.500000,0.809017,0.525731,0.000000,0.850651,0.295242,0.000000,0.955423,0.442863,0.238856,0.864188,0.162460,0.262866,0.951056,-0.681718,0.147621,0.716567,-0.809017,0.309017,0.500000,-0.587785,0.425325,0.688191,-0.850651,0.525731,0.000000,-0.864188,0.442863,0.238856,-0.716567,0.681718,0.147621,-0.688191,0.587785,0.425325,-0.500000,0.809017,0.309017,-0.238856,0.864188,0.442863,-0.425325,0.688191,0.587785,-0.716567,0.681718,-0.147621,-0.500000,0.809017,-0.309017,-0.525731,0.850651,0.000000,0.000000,0.850651,-0.525731,-0.238856,0.864188,-0.442863,0.000000,0.955423,-0.295242,-0.262866,0.951056,-0.162460,0.000000,1.000000,0.000000,0.000000,0.955423,0.295242,-0.262866,0.951056,0.162460,0.238856,0.864188,0.442863,0.262866,0.951056,0.162460,0.500000,0.809017,0.309017,0.238856,0.864188,-0.442863,0.262866,0.951056,-0.162460,0.500000,0.809017,-0.309017,0.850651,0.525731,0.000000,0.716567,0.681718,0.147621,0.716567,0.681718,-0.147621,0.525731,0.850651,0.000000,0.425325,0.688191,0.587785,0.864188,0.442863,0.238856,0.688191,0.587785,0.425325,0.809017,0.309017,0.500000,0.681718,0.147621,0.716567,0.587785,0.425325,0.688191,0.955423,0.295242,0.000000,1.000000,0.000000,0.000000,0.951056,0.162460,0.262866,0.850651,-0.525731,0.000000,0.955423,-0.295242,0.000000,0.864188,-0.442863,0.238856,0.951056,-0.162460,0.262866,0.809017,-0.309017,0.500000,0.681718,-0.147621,0.716567,0.850651,0.000000,0.525731,0.864188,0.442863,-0.238856,0.809017,0.309017,-0.500000,0.951056,0.162460,-0.262866,0.525731,0.000000,-0.850651,0.681718,0.147621,-0.716567,0.681718,-0.147621,-0.716567,0.850651,0.000000,-0.525731,0.809017,-0.309017,-0.500000,0.864188,-0.442863,-0.238856,0.951056,-0.162460,-0.262866,0.147621,0.716567,-0.681718,0.309017,0.500000,-0.809017,0.425325,0.688191,-0.587785,0.442863,0.238856,-0.864188,0.587785,0.425325,-0.688191,0.688191,0.587785,-0.425325,-0.147621,0.716567,-0.681718,-0.309017,0.500000,-0.809017,0.000000,0.525731,-0.850651,-0.525731,0.000000,-0.850651,-0.442863,0.238856,-0.864188,-0.295242,0.000000,-0.955423,-0.162460,0.262866,-0.951056,0.000000,0.000000,-1.000000,0.295242,0.000000,-0.955423,0.162460,0.262866,-0.951056,-0.442863,-0.238856,-0.864188,-0.309017,-0.500000,-0.809017,-0.162460,-0.262866,-0.951056,0.000000,-0.850651,-0.525731,-0.147621,-0.716567,-0.681718,0.147621,-0.716567,-0.681718,0.000000,-0.525731,-0.850651,0.309017,-0.500000,-0.809017,0.442863,-0.238856,-0.864188,0.162460,-0.262866,-0.951056,0.238856,-0.864188,-0.442863,0.500000,-0.809017,-0.309017,0.425325,-0.688191,-0.587785,0.716567,-0.681718,-0.147621,0.688191,-0.587785,-0.425325,0.587785,-0.425325,-0.688191,0.000000,-0.955423,-0.295242,0.000000,-1.000000,0.000000,0.262866,-0.951056,-0.162460,0.000000,-0.850651,0.525731,0.000000,-0.955423,0.295242,0.238856,-0.864188,0.442863,0.262866,-0.951056,0.162460,0.500000,-0.809017,0.309017,0.716567,-0.681718,0.147621,0.525731,-0.850651,0.000000,-0.238856,-0.864188,-0.442863,-0.500000,-0.809017,-0.309017,-0.262866,-0.951056,-0.162460,-0.850651,-0.525731,0.000000,-0.716567,-0.681718,-0.147621,-0.716567,-0.681718,0.147621,-0.525731,-0.850651,0.000000,-0.500000,-0.809017,0.309017,-0.238856,-0.864188,0.442863,-0.262866,-0.951056,0.162460,-0.864188,-0.442863,0.238856,-0.809017,-0.309017,0.500000,-0.688191,-0.587785,0.425325,-0.681718,-0.147621,0.716567,-0.442863,-0.238856,0.864188,-0.587785,-0.425325,0.688191,-0.309017,-0.500000,0.809017,-0.147621,-0.716567,0.681718,-0.425325,-0.688191,0.587785,-0.162460,-0.262866,0.951056,0.442863,-0.238856,0.864188,0.162460,-0.262866,0.951056,0.309017,-0.500000,0.809017,0.147621,-0.716567,0.681718,0.000000,-0.525731,0.850651,0.425325,-0.688191,0.587785,0.587785,-0.425325,0.688191,0.688191,-0.587785,0.425325,-0.955423,0.295242,0.000000,-0.951056,0.162460,0.262866,-1.000000,0.000000,0.000000,-0.850651,0.000000,0.525731,-0.955423,-0.295242,0.000000,-0.951056,-0.162460,0.262866,-0.864188,0.442863,-0.238856,-0.951056,0.162460,-0.262866,-0.809017,0.309017,-0.500000,-0.864188,-0.442863,-0.238856,-0.951056,-0.162460,-0.262866,-0.809017,-0.309017,-0.500000,-0.681718,0.147621,-0.716567,-0.681718,-0.147621,-0.716567,-0.850651,0.000000,-0.525731,-0.688191,0.587785,-0.425325,-0.587785,0.425325,-0.688191,-0.425325,0.688191,-0.587785,-0.425325,-0.688191,-0.587785,-0.587785,-0.425325,-0.688191,-0.688191,-0.587785,-0.425325];K3D.parse.fromCollada=function(buff){var str=K3D.parse._buffToStr(buff);var xml=new DOMParser().parseFromString(str,"text/xml");xml=xml.childNodes[0];var resp={};var ass=xml.getElementsByTagName("asset")[0];var geo=xml.getElementsByTagName("library_geometries")[0];var ima=xml.getElementsByTagName("library_images")[0];var mat=xml.getElementsByTagName("library_materials")[0];var eff=xml.getElementsByTagName("library_effects")[0];if(ass)resp.asset=K3D.parse.fromCollada._asset(ass);if(geo)resp.geometries=K3D.parse.fromCollada._libGeometries(geo);if(ima)resp.images=K3D.parse.fromCollada._libImages(ima);if(mat)resp.materials=K3D.parse.fromCollada._libMaterials(mat);if(eff)resp.effects=K3D.parse.fromCollada._libEffects(eff);return resp}K3D.parse.fromCollada._asset=function(xml){return{created:xml.getElementsByTagName("created")[0].textContent,modified:xml.getElementsByTagName("modified")[0].textContent,up_axis:xml.getElementsByTagName("up_axis")[0].textContent}}K3D.parse.fromCollada._libGeometries=function(xml){xml=xml.getElementsByTagName("geometry");var res=[];for(var i=0;i<xml.length;i++){var g=xml[i];var o=K3D.parse.fromCollada._getMesh(g.getElementsByTagName("mesh")[0]);res.push(o)}return res}K3D.parse.fromCollada._getMesh=function(mesh){var res={};var ss=mesh.getElementsByTagName("source");var sources=res.sources={};for(var i=0;i<ss.length;i++){var farr=ss[i].getElementsByTagName("float_array")[0].textContent.split(" ");var fl=farr.length-(farr[farr.length-1]==""?1:0);var arr=new Array(fl);for(var j=0;j<fl;j++)arr[j]=parseFloat(farr[j]);sources[ss[i].getAttribute("id")]=arr}res.triangles=[];var tgs=mesh.getElementsByTagName("triangles");if(tgs==null)return res;for(var i=0;i<tgs.length;i++){var t={};var tnode=tgs[i];t.material=tnode.getAttribute("material");var inputs=tnode.getElementsByTagName("input");var inds=[];for(var j=0;j<inputs.length;j++){var inp=inputs[j],arr=[];inds[parseInt(inp.getAttribute("offset"))]=arr;var par=inp.getAttribute("semantic");t["s_"+par]=(par=="VERTEX")?mesh.getElementsByTagName("vertices")[0].getElementsByTagName("input")[0].getAttribute("source").substring(1):inp.getAttribute("source").substring(1);t["i_"+par]=arr;var psrc=sources[t["s_"+par]]}var indices=tnode.getElementsByTagName("p")[0].textContent.split(" ");var inum=3*Math.floor(indices.length/3);for(var j=0;j<inum;j++)inds[j%inputs.length].push(parseInt(indices[j]));res.triangles.push(t)}return res}K3D.parse.fromCollada._libImages=function(xml){xml=xml.getElementsByTagName("image");var res={};for(var i=0;i<xml.length;i++){res[xml[i].getAttribute("id")]=xml[i].getElementsByTagName("init_from")[0].textContent}return res}K3D.parse.fromCollada._libMaterials=function(xml){xml=xml.getElementsByTagName("material");var res={};for(var i=0;i<xml.length;i++){res[xml[i].getAttribute("name")]=xml[i].getElementsByTagName("instance_effect")[0].getAttribute("url").substring(1)}return res}K3D.parse.fromCollada._libEffects=function(xml){xml=xml.getElementsByTagName("effect");var res={};for(var i=0;i<xml.length;i++){var eff={};var params=xml[i].getElementsByTagName("newparam");for(var j=0;j<params.length;j++){var srf=params[j].getElementsByTagName("surface")[0];if(srf)eff.surface=srf.getElementsByTagName("init_from")[0].textContent}res[xml[i].getAttribute("id")]=eff}return res}K3D.parse.from3DS=function(buff){buff=new Uint8Array(buff);var res={};if(K3D.bin.rsl(buff,0)!=0x4d4d)return null;var lim=K3D.bin.ril(buff,2);var off=6;while(off<lim){var cid=K3D.bin.rsl(buff,off);var lng=K3D.bin.ril(buff,off+2);if(cid==0x3d3d)res.edit=K3D.parse.from3DS._edit3ds(buff,off,lng);if(cid==0xb000)res.keyf=K3D.parse.from3DS._keyf3ds(buff,off,lng);off+=lng}return res}K3D.parse.from3DS._edit3ds=function(buff,coff,clng){var res={};var off=coff+6;while(off<coff+clng){var cid=K3D.bin.rsl(buff,off);var lng=K3D.bin.ril(buff,off+2);if(cid==0x4000){if(res.objects==null)res.objects=[];res.objects.push(K3D.parse.from3DS._edit_object(buff,off,lng))}off+=lng}return res}K3D.parse.from3DS._keyf3ds=function(buff,coff,clng){var res={};var off=coff+6;while(off<coff+clng){var cid=K3D.bin.rsl(buff,off);var lng=K3D.bin.ril(buff,off+2);if(cid==0xb002){if(res.desc==null)res.desc=[];res.desc.push(K3D.parse.from3DS._keyf_objdes(buff,off,lng))}off+=lng}return res}K3D.parse.from3DS._keyf_objdes=function(buff,coff,clng){var res={};var off=coff+6;while(off<coff+clng){var cid=K3D.bin.rsl(buff,off);var lng=K3D.bin.ril(buff,off+2);if(cid==0xb010)res.hierarchy=K3D.parse.from3DS._keyf_objhierarch(buff,off,lng);if(cid==0xb011)res.dummy_name=K3D.bin.rASCII0(buff,off+6);off+=lng}return res}K3D.parse.from3DS._keyf_objhierarch=function(buff,coff,clng){var res={};var off=coff+6;res.name=K3D.bin.rASCII0(buff,off);off+=res.name.length+1;res.hierarchy=K3D.bin.rsl(buff,off+4);return res}K3D.parse.from3DS._edit_object=function(buff,coff,clng){var res={};var off=coff+6;res.name=K3D.bin.rASCII0(buff,off);off+=res.name.length+1;while(off<coff+clng){var cid=K3D.bin.rsl(buff,off);var lng=K3D.bin.ril(buff,off+2);if(cid==0x4100)res.mesh=K3D.parse.from3DS._obj_trimesh(buff,off,lng);off+=lng}return res}K3D.parse.from3DS._obj_trimesh=function(buff,coff,clng){var res={};var off=coff+6;while(off<coff+clng){var cid=K3D.bin.rsl(buff,off);var lng=K3D.bin.ril(buff,off+2);if(cid==0x4110)res.vertices=K3D.parse.from3DS._tri_vertexl(buff,off,lng);if(cid==0x4120)res.indices=K3D.parse.from3DS._tri_facel1(buff,off,lng);if(cid==0x4140)res.uvt=K3D.parse.from3DS._tri_mappingcoors(buff,off,lng);if(cid==0x4160)res.local=K3D.parse.from3DS._tri_local(buff,off,lng);off+=lng}return res}K3D.parse.from3DS._tri_vertexl=function(buff,coff,clng){var res=[];var off=coff+6;var n=K3D.bin.rsl(buff,off);off+=2;for(var i=0;i<n;i++){res.push(K3D.bin.rf(buff,off));res.push(K3D.bin.rf(buff,off+4));res.push(K3D.bin.rf(buff,off+8));off+=12}return res}K3D.parse.from3DS._tri_facel1=function(buff,coff,clng){var res=[];var off=coff+6;var n=K3D.bin.rsl(buff,off);off+=2;for(var i=0;i<n;i++){res.push(K3D.bin.rsl(buff,off));res.push(K3D.bin.rsl(buff,off+2));res.push(K3D.bin.rsl(buff,off+4));off+=8}return res}K3D.parse.from3DS._tri_mappingcoors=function(buff,coff,clng){var res=[];var off=coff+6;var n=K3D.bin.rsl(buff,off);off+=2;for(var i=0;i<n;i++){res.push(K3D.bin.rf(buff,off));res.push(1-K3D.bin.rf(buff,off+4));off+=8}return res}K3D.parse.from3DS._tri_local=function(buff,coff,clng){var res={};var off=coff+6;res.X=[K3D.bin.rf(buff,off),K3D.bin.rf(buff,off+4),K3D.bin.rf(buff,off+8)];off+=12;res.Y=[K3D.bin.rf(buff,off),K3D.bin.rf(buff,off+4),K3D.bin.rf(buff,off+8)];off+=12;res.Z=[K3D.bin.rf(buff,off),K3D.bin.rf(buff,off+4),K3D.bin.rf(buff,off+8)];off+=12;res.C=[K3D.bin.rf(buff,off),K3D.bin.rf(buff,off+4),K3D.bin.rf(buff,off+8)];off+=12;return res}K3D.parse.fromBIV=function(buff){buff=new Uint8Array(buff);var res={};var head={};head.id=K3D.bin.ril(buff,0);head.verS=K3D.bin.ril(buff,4);head.texS=K3D.bin.ril(buff,8);head.indS=K3D.bin.ril(buff,12);head.verO=K3D.bin.ril(buff,16);head.verL=K3D.bin.ril(buff,20);head.texO=K3D.bin.ril(buff,24);head.texL=K3D.bin.ril(buff,28);head.indO=K3D.bin.ril(buff,32);head.indL=K3D.bin.ril(buff,36);if(head.verO!=0)res.vertices=K3D.parse.fromBIV._readFloats(buff,head.verO,head.verL);if(head.texO!=0)res.uvt=K3D.parse.fromBIV._readFloats(buff,head.texO,head.texL);if(head.indO!=0)res.indices=K3D.parse.fromBIV._readInts(buff,head.indO,head.indL,head.indS);return res}K3D.parse.toBIV=function(obj){var maxi=0;for(var i=0;i<obj.indices.length;i++)maxi=Math.max(maxi,obj.indices[i]);var indS=32;if(maxi<=0xffff)indS=16;var len=40;if(obj.vertices)len+=obj.vertices.length*4;if(obj.uvt)len+=obj.uvt.length*4;if(obj.indices)len+=obj.indices.length*indS/8;var buff=new Uint8Array(len);K3D.bin.wil(buff,0,0x6976616e);K3D.bin.wil(buff,4,32);K3D.bin.wil(buff,8,32);K3D.bin.wil(buff,12,indS);var off=40;if(obj.vertices){K3D.bin.wil(buff,16,off);K3D.bin.wil(buff,20,4*obj.vertices.length);K3D.parse.fromBIV._writeFloats(buff,off,obj.vertices);off+=4*obj.vertices.length}if(obj.uvt){K3D.bin.wil(buff,24,off);K3D.bin.wil(buff,28,4*obj.uvt.length);K3D.parse.fromBIV._writeFloats(buff,off,obj.uvt);off+=4*obj.uvt.length}if(obj.indices){K3D.bin.wil(buff,32,off);K3D.bin.wil(buff,36,4*obj.indices.length);K3D.parse.fromBIV._writeInts(buff,off,obj.indices,indS)}return buff.buffer}K3D.parse.fromBIV._readFloats=function(buff,off,len){var arr=[];for(var i=0;i<len/4;i++)arr.push(K3D.bin.rf(buff,off+4*i));return arr}K3D.parse.fromBIV._writeFloats=function(buff,off,arr){for(var i=0;i<arr.length;i++)K3D.bin.wf(buff,off+4*i,arr[i])}K3D.parse.fromBIV._readInts=function(buff,off,len,cs){var arr=[];for(var i=0;i<len/4;i++){if(cs==16)arr.push(K3D.bin.rsl(buff,off+2*i));if(cs==32)arr.push(K3D.bin.ril(buff,off+4*i))}return arr}K3D.parse.fromBIV._writeInts=function(buff,off,arr,cs){for(var i=0;i<arr.length;i++){if(cs==16)K3D.bin.wsl(buff,off+2*i,arr[i]);if(cs==32)K3D.bin.wil(buff,off+4*i,arr[i])}}K3D.gen={};K3D.gen.Plane=function(sw,sh,tsw,tsh){if(!tsw)tsw=1;if(!tsh)tsh=1;var r={verts:[],inds:[],uvt:[]};var ssw=sw+1,ssh=sh+1 for(var i=0;i<ssh;i++){for(var j=0;j<ssw;j++){var x=-1+j*(2/sw);var y=-1+i*(2/sh);r.verts.push(x,y,0);r.uvt.push(tsw*j/sw,tsh*i/sh);if(i<sh&&j<sw)r.inds.push(i*ssw+j,i*ssw+j+1,(i+1)*ssw+j,i*ssw+j+1,(i+1)*ssw+j,(i+1)*ssw+j+1)}}return r}K3D.gen.Cube=function(){var r={verts:[-1,1,-1,1,1,-1,-1,-1,-1,1,-1,-1,-1,1,1,1,1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,-1,1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,-1,1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,-1,-1,1,1,-1,1],inds:[0,1,2,1,2,3,4,5,6,5,6,7,8,9,10,9,10,11,12,13,14,13,14,15,16,17,18,17,18,19,20,21,22,21,22,23],uvt:[1/4,1/4,2/4,1/4,1/4,2/4,2/4,2/4,4/4,1/4,3/4,1/4,4/4,2/4,3/4,2/4,0/4,1/4,1/4,1/4,0/4,2/4,1/4,2/4,3/4,1/4,2/4,1/4,3/4,2/4,2/4,2/4,1/4,1/4,2/4,1/4,1/4,0/4,2/4,0/4,1/4,2/4,2/4,2/4,1/4,3/4,2/4,3/4,]};return r}K3D.gen.Sphere=function(sx,sy){var r={verts:[],inds:[],uvt:[]};var dx=2*Math.PI/sx;var dy=Math.PI/sy;var nx=sx+1,ny=sy+1;for(var i=0;i<ny;i++){for(var j=0;j<nx;j++){var lat=-Math.PI/2+i*Math.PI/sy;var lon=j*2*Math.PI/sx;var x=Math.cos(lat)*Math.cos(lon);var y=Math.sin(lat);var z=Math.cos(lat)*Math.sin(lon);r.verts.push(x,y,z);r.uvt.push(j/sx,i/sy);if(i<sy&&j<sx)r.inds.push(nx*i+j,nx*i+j+1,nx*(i+1)+j,nx*i+j+1,nx*(i+1)+j,nx*(i+1)+j+1)}}return r}K3D.mat={};K3D.mat.scale=function(x,y,z){return[x,0,0,0,0,y,0,0,0,0,z,0,0,0,0,1]}K3D.mat.translate=function(x,y,z){return[1,0,0,0,0,1,0,0,0,0,1,0,x,y,z,1]}K3D.mat.rotateDeg=function(x,y,z){var r=Math.PI/180;return K3D.mat.rotate(x*r,y*r,z*r)}K3D.mat.rotate=function(x,y,z){var m=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];var a=x;var b=y;var g=z;var ca=Math.cos(a),cb=Math.cos(b),cg=Math.cos(g);var sa=Math.sin(a),sb=Math.sin(b),sg=Math.sin(g);m[0]=cb*cg;m[1]=-cb*sg;m[2]=sb;m[4]=(ca*sg+sa*sb*cg);m[5]=(ca*cg-sa*sb*sg);m[6]=-sa*cb;m[8]=(sa*sg-ca*sb*cg);m[9]=(sa*cg+ca*sb*sg);m[10]=ca*cb;return m}K3D.edit={};K3D.edit.interpolate=function(a,b,d,t){for(var i=0;i<a.length;i++)d[i]=a[i]+t*(b[i]-a[i])}K3D.edit.transform=function(a,m){for(var i=0;i<a.length;i+=3){var x=a[i],y=a[i+1],z=a[i+2];a[i+0]=m[0]*x+m[4]*y+m[8]*z+m[12];a[i+1]=m[1]*x+m[5]*y+m[9]*z+m[13];a[i+2]=m[2]*x+m[6]*y+m[10]*z+m[14]}}K3D.edit.unwrap=function(ind,crd,cpi){var ncrd=new Array(Math.floor(ind.length/3)*cpi);for(var i=0;i<ind.length;i++){for(var j=0;j<cpi;j++){ncrd[i*cpi+j]=crd[ind[i]*cpi+j]}}return ncrd}K3D.edit.remap=function(ind,nind,arr,cpi){var ncrd=new Array(arr.length);for(var i=0;i<ind.length;i++){for(var j=0;j<cpi;j++){ncrd[nind[i]*cpi+j]=arr[ind[i]*cpi+j]}}return ncrd}K3D.utils={};K3D.utils.getAABB=function(vts){var minx,miny,minz,maxx,maxy,maxz;minx=miny=minz=999999999;maxx=maxy=maxz=-minx;for(var i=0;i<vts.length;i+=3){var vx=vts[i+0];var vy=vts[i+1];var vz=vts[i+2];if(vx<minx)minx=vx;if(vx>maxx)maxx=vx;if(vy<miny)miny=vy;if(vy>maxy)maxy=vy;if(vz<minz)minz=vz;if(vy>maxz)maxz=vz}return{min:{x:minx,y:miny,z:minz},max:{x:maxx,y:maxy,z:maxz}}}var QUARTZ={REVISION:'1'};var gl=null;QUARTZ.textures=new Array();QUARTZ.textureFiles=new Array();QUARTZ.models=new Array();QUARTZ.modelFiles=new Array();QUARTZ.lightsArray=new Array();QUARTZ.modelView=null;QUARTZ.root=null;QUARTZ.program=null;QUARTZ.getRoot=function(){if(QUARTZ.root==null){QUARTZ.root=new QUARTZ.Node();QUARTZ.root.entity=new QUARTZ.Scene()}return QUARTZ.root}QUARTZ.pushMatrix=function(mv){QUARTZ.modelView.push(mv)}QUARTZ.popMatrix=function(){if(QUARTZ.modelView.length>0)QUARTZ.modelView.splice(QUARTZ.modelView.length-1,1)}QUARTZ.getMVMatrix=function(){if(QUARTZ.modelView.length>0)return QUARTZ.modelView[QUARTZ.modelView.length-1];else console.log("modelView stack is empty");return null}QUARTZ.Node=function(){this.children=new Array();return this};QUARTZ.Node.prototype={constructor:QUARTZ.Node,entity:null,dad:null,children:new Array(),setEntity:function(value){if(value instanceof QUARTZ.Entity){this.entity=value}return true},setDad:function(value){if(value instanceof QUARTZ.Node){this.dad=value}return true},addChild:function(node){if(node instanceof QUARTZ.Node){return this.children.push(node)}return-1},draw:function(){this.entity.beginDraw(this.children);this.entity.endDraw()},remHijoByIndex:function(index){this.children.splice(index,1)},remHijoByNode:function(node){for(var index in this.children){if(this.children[index]==node){this.children.splice(index,1)}}}};QUARTZ.Scene=function(){return this}QUARTZ.Scene.prototype={constructor:QUARTZ.Scene,beginDraw:function(children){for(var i=0;i<children.length;i++){children[i].draw()}},endDraw:function(){}}QUARTZ.Color=function(r,g,b,a){return this}QUARTZ.Color.prototype={constructor:QUARTZ.Color,color:null,r:1,g:1,b:1,a:1,setColor:function(r,g,b,a){a=typeof a!=='undefined'?a:1.0;this.r=r;this.g=g;this.b=b;this.a=a;color=vec4(r,g,b,a)}}QUARTZ.Light=function(amb,dif,spec,direction,position,intensity){type:null;amb:null;dif:null;spec:null;position:null;direction:null;intensity:null;this.setLight(amb,dif,spec,direction,position,intensity);return this}QUARTZ.Light.prototype={constructor:QUARTZ.Light,type:null,amb:null,dif:null,spec:null,position:null,direction:null,intensity:null,setAmbient:function(amb){this.amb=amb},setDiffuse:function(dif){this.dif=dif},setSpecular:function(spec){this.spec=spec},setDirection:function(dir){this.direction=dir},setPosition:function(pos){this.position=pos},setIntensity:function(inten){this.intensity=inten},setLight:function(amb,dif,spec,dir,pos,inten){this.setAmbient(amb);this.setDiffuse(dif);this.setSpecular(spec);this.setDirection(dir);this.setPosition(pos);this.setIntensity(inten)},beginDraw:function(children){for(var i=0;i<children.length;i++){children[i].draw()}},endDraw:function(){}}QUARTZ.Mesh=function(){this.vertices=new Float32Array();this.normals=new Float32Array();this.uvt=new Float32Array();this.ind=new Array();this.fileURL="";this.textureURL="";this.textureNum=null;this.texture=null;this.textureImg=null;this.color=[1,1,1,1];return this}QUARTZ.Mesh.prototype={constructor:QUARTZ.Mesh,vertices:null,normals:null,uvt:null,ind:null,fileURL:null,color:QUARTZ.Color("1","1","1"),setVertices:function(ver){this.vertices=ver},initTextures:function(gl,mesh){if(QUARTZ.textures.indexOf(this.textureURL)<0){this.texture=gl.createTexture();this.textureImg=new Image();this.textureImg.src=this.textureURL;this.textureImg.onload=function(){mesh.handleTextureLoaded(mesh.textureImg,mesh.texture)}}},handleTextureLoaded:function(image,texture){gl.bindTexture(gl.TEXTURE_2D,texture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_NEAREST);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,image);gl.generateMipmap(gl.TEXTURE_2D);gl.bindTexture(gl.TEXTURE_2D,null);var cadenas=image.src.split("/");if(QUARTZ.textures.indexOf(cadenas[cadenas.length-1])<0){QUARTZ.textures.push(cadenas[cadenas.length-1]);QUARTZ.textureFiles.push([image,texture,cadenas[cadenas.length-1]])}this.textureNum=QUARTZ.textures.indexOf(this.textureImg.src)},setNormals:function(norm){this.normals=norm},setUvt:function(uvt){this.uvt=uvt},setIndexes:function(index){this.ind=index},initArrays:function(m,mesh){var model=null;var existing=false;if(mesh.fileURL.search(".obj")>-1){if(QUARTZ.models.indexOf(mesh.fileURL)<0){QUARTZ.models.push(mesh.fileURL);model=K3D.parse.fromOBJ(m)}else{existing=true;var index=QUARTZ.models.indexOf(mesh.fileURL);var mdata=QUARTZ.modelFiles[index];mesh.vertices=mdata[0];mesh.normals=mdata[1];mesh.uvt=mdata[2];mesh.ind=mdata[3]}}if(model!=null&&!existing){mesh.vertices=new Float32Array(K3D.edit.unwrap(model.i_verts,model.c_verts,3));mesh.normals=new Float32Array(K3D.edit.unwrap(model.i_norms,model.c_norms,3));mesh.uvt=new Float32Array(K3D.edit.unwrap(model.i_uvt,model.c_uvt,2));var indicess=new Array();for(var i=0;i<model.i_verts.length;i++){indicess.push(i)}mesh.ind=new Int16Array(indicess);QUARTZ.modelFiles.push([mesh.vertices,mesh.normals,mesh.uvt,mesh.ind])}},loadModel:function(fURL){this.fileURL=fURL;K3D.load(this.fileURL,this.initArrays,this)},loadTexture:function(tURL){this.textureURL=tURL},beginDraw:function(){var prog;if(QUARTZ.program==null){prog=gl.createProgram();var addshader=function(type,source){var s=gl.createShader((type=='vertex')?gl.VERTEX_SHADER:gl.FRAGMENT_SHADER);gl.shaderSource(s,source);gl.compileShader(s);if(!gl.getShaderParameter(s,gl.COMPILE_STATUS)){throw"Could not compile "+type+" shader:\n\n"+gl.getShaderInfoLog(s);}gl.attachShader(prog,s)};addshader('vertex',QUARTZ.getVertexShader());addshader('fragment',QUARTZ.getFragmentShader());QUARTZ.program=prog;gl.linkProgram(prog);gl.useProgram(prog)}else{prog=QUARTZ.program}var persp=mat4.create();mat4.perspective(45,QUARTZ.cwidth/QUARTZ.cheight,0.1,10000,persp);var mv=QUARTZ.getMVMatrix();prog.aVertexPosition=gl.getAttribLocation(prog,"aVertexPosition");prog.aVertexNormal=gl.getAttribLocation(prog,"aVertexNormal");prog.aTextureCoord=gl.getAttribLocation(prog,"aTextureCoord");prog.uPMatrix=gl.getUniformLocation(prog,"uPMatrix");prog.uMVMatrix=gl.getUniformLocation(prog,"uMVMatrix");prog.uNMatrix=gl.getUniformLocation(prog,"uNMatrix");prog.uModelColor=gl.getUniformLocation(prog,"uModelColor");var normalMatrix=mat4.create();mat4.set(mv,normalMatrix);mat4.inverse(normalMatrix);mat4.transpose(normalMatrix);if(QUARTZ.lightsArray.length>0){prog.uAmbientColor=gl.getUniformLocation(prog,"uAmbientColor");var ambient=new Array();for(var i=0;i<QUARTZ.lightsArray.length;i++){ambient.push(QUARTZ.lightsArray[i].amb[0],QUARTZ.lightsArray[i].amb[1],QUARTZ.lightsArray[i].amb[2])}gl.uniform3fv(prog.uAmbientColor,new Float32Array(ambient));prog.uPointLightingColor=gl.getUniformLocation(prog,"uPointLightingColor");var diffuse=new Array();for(var i=0;i<QUARTZ.lightsArray.length;i++){diffuse.push(QUARTZ.lightsArray[i].dif[0],QUARTZ.lightsArray[i].dif[1],QUARTZ.lightsArray[i].dif[2])}gl.uniform3fv(prog.uPointLightingColor,new Float32Array(diffuse));prog.uPointLightingLocation=gl.getUniformLocation(prog,"uPointLightingLocation");var location=new Array();for(var i=0;i<QUARTZ.lightsArray.length;i++){location.push(QUARTZ.lightsArray[i].position[0],QUARTZ.lightsArray[i].position[1],QUARTZ.lightsArray[i].position[2])}gl.uniform3fv(prog.uPointLightingLocation,new Float32Array(location));prog.uPointLightingIntensity=gl.getUniformLocation(prog,"uPointLightingIntensity");var intensity=new Array();for(var i=0;i<QUARTZ.lightsArray.length;i++){intensity.push(QUARTZ.lightsArray[i].intensity)}gl.uniform1fv(prog.uPointLightingIntensity,intensity);prog.uSpecularFactor=gl.getUniformLocation(prog,"uSpecularFactor");var specular=new Array();for(var i=0;i<QUARTZ.lightsArray.length;i++){specular.push(QUARTZ.lightsArray[i].spec)}gl.uniform1fv(prog.uSpecularFactor,specular)}gl.activeTexture(gl.TEXTURE1);gl.bindTexture(gl.TEXTURE_2D,this.texture);if(this.textureURL!=""){gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,this.texture);gl.uniform1i(gl.getUniformLocation(prog,"uSampler"),0);gl.uniform1i(gl.getUniformLocation(prog,"uUseTextures"),1);this.initTextures(gl,this)}else{gl.bindTexture(gl.TEXTURE_2D,this.texture);gl.uniform1i(gl.getUniformLocation(prog,"uUseTextures"),0)}gl.enableVertexAttribArray(prog.aVertexPosition);gl.enableVertexAttribArray(prog.aVertexNormal);gl.enableVertexAttribArray(prog.aTextureCoord);gl.uniform4fv(prog.uModelColor,new Float32Array(this.color));gl.uniformMatrix4fv(prog.uMVMatrix,false,mv);gl.uniformMatrix4fv(prog.uPMatrix,false,persp);gl.uniformMatrix4fv(prog.uNMatrix,false,normalMatrix);if(!gl.getProgramParameter(prog,gl.LINK_STATUS)){throw"Could not link the shader program!";}var bNormals=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,bNormals);gl.bufferData(gl.ARRAY_BUFFER,this.normals,gl.STATIC_DRAW);gl.vertexAttribPointer(prog.aVertexNormal,3,gl.FLOAT,false,0,0);var bUvt=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,bUvt);gl.bufferData(gl.ARRAY_BUFFER,this.uvt,gl.STATIC_DRAW);gl.vertexAttribPointer(prog.aTextureCoord,2,gl.FLOAT,false,0,0);var bVertex=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,bVertex);gl.bufferData(gl.ARRAY_BUFFER,this.vertices,gl.STATIC_DRAW);gl.vertexAttribPointer(prog.aVertexPosition,3,gl.FLOAT,false,0,0);var bIndexes=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,bIndexes);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,this.ind,gl.STATIC_DRAW);gl.drawElements(gl.TRIANGLES,this.ind.length,gl.UNSIGNED_SHORT,0);gl.deleteBuffer(bNormals);gl.deleteBuffer(bUvt);gl.deleteBuffer(bVertex);gl.deleteBuffer(bIndexes)},endDraw:function(){}}QUARTZ.Transf=function(){this.rot=new Array();this.tras=null;return this}QUARTZ.Transf.prototype={constructor:QUARTZ.Transf,tras:null,sca:null,identity:function(mat){mat4.identity(mat)},load:function(origin,target){mat4.set(origin,target)},transpose:function(mat){mat4.transpose(mat)},setTraslation:function(x,y,z){this.tras=[x,y,z]},traslate:function(mat){if(this.tras!=null)mat4.translate(mat,this.tras)},scale:function(mat){if(this.sca!=null)mat4.scale(mat,this.sca)},addRotation:function(ang,axis){if(this.rot==null){this.rot=new Array(2);this.rot.push([ang,axis])}else this.rot.push([ang,axis])},rotate:function(mat){var matrix=mat4.create();for(var i=0;i<this.rot.length;i++){var ang=this.rot[i][0];var axis=this.rot[i][1];matrix=mat;mat4.rotate(matrix,(ang*Math.PI/180),axis)}matrix=mat;return matrix},setScale:function(x,y,z){if(typeof y!=='undefined'){this.sca=[x,y,z]}else{this.sca=[x,x,x]}},beginDraw:function(children){mv=new Float32Array(QUARTZ.getMVMatrix());this.traslate(mv);mv=this.rotate(mv);this.scale(mv);QUARTZ.pushMatrix(mv);for(var i=0;i<children.length;i++){children[i].draw()}},endDraw:function(){QUARTZ.popMatrix()}}QUARTZ.createMesh=function(){var mesh=new QUARTZ.Mesh();return mesh};QUARTZ.createLight=function(){var light=new QUARTZ.Light();return light};QUARTZ.createTransform=function(){var transf=new QUARTZ.Transf();return transf};QUARTZ.addMesh=function(mesh,parent){if(parent instanceof QUARTZ.Node){if(mesh instanceof QUARTZ.Mesh){var nodo=new QUARTZ.Node();nodo.entity=mesh;parent.addChild(nodo);return nodo}else alert("There was a problem when adding mesh. It's not a Mesh.")}else alert("There was a problem when adding mesh. Parent is not a Node.")}QUARTZ.addTransform=function(transf,parent){if(parent instanceof QUARTZ.Node){if(transf instanceof QUARTZ.Transf){var nodo=new QUARTZ.Node();nodo.entity=transf;parent.addChild(nodo);return nodo}else alert("There was a problem when adding a tranformation. It's not a Transformation.")}else alert("There was a problem when adding transformation. Parent is not a Node.")}QUARTZ.addLight=function(light,parent){if(parent instanceof QUARTZ.Node){if(light instanceof QUARTZ.Light){QUARTZ.lightsArray.push(light);var nodo=new QUARTZ.Node();nodo.entity=light;return nodo}else alert("There was a problem when adding light "+(QUARTZ.lightsArray.length+1)+". It's not a light.")}else alert("There was a problem when adding light "+(QUARTZ.lightsArray.length+1)+". Parent is not a Node.")};QUARTZ.getVertexShader=function(){var vshader="";if(QUARTZ.lightsArray.length>0)vshader+="const int numLights = "+QUARTZ.lightsArray.length+";";else vshader+="const int numLights = 1;";vshader+="attribute vec3 aVertexNormal;";vshader+="attribute vec3 aVertexPosition;";vshader+="attribute vec2 aTextureCoord;";vshader+="attribute vec3 aVertexColor;";vshader+="uniform highp mat4 uMVMatrix;";vshader+="uniform highp mat4 uPMatrix;";vshader+="uniform highp mat4 uNMatrix;";vshader+="uniform mediump vec4 uModelColor;";vshader+="uniform mediump vec3 uAmbientColor[numLights];";vshader+="uniform mediump vec3 uPointLightingLocation[numLights];";vshader+="uniform mediump vec3 uPointLightingColor[numLights];";vshader+="uniform mediump float uniformPointLightingIntensity[numLights];";vshader+="uniform mediump float uSpecularFactor[numLights];";vshader+="uniform sampler2D uSampler;";vshader+="varying vec3 vColor;";vshader+="varying vec4 mvPosition;";vshader+="varying mediump vec4 transformedNormal;";vshader+="varying vec2 vTextureCoord;";vshader+="void main(void) {";vshader+="	  mvPosition = uMVMatrix * vec4(aVertexPosition,1.0);"vshader+="	  gl_Position = uPMatrix * mvPosition;";vshader+="    transformedNormal =  normalize(uNMatrix * vec4(aVertexNormal, 1.0));";vshader+="	  vTextureCoord = aTextureCoord;";vshader+="    vColor = vec3(1,1,1);";vshader+="}";return vshader}QUARTZ.getFragmentShader=function(){var fshader="";if(QUARTZ.lightsArray.length>0)fshader+="const int numLights = "+QUARTZ.lightsArray.length+";";else fshader+="const int numLights = 1;";fshader+="varying mediump vec3 vColor;";fshader+="mediump vec3 vLightWeighting;";fshader+="varying highp vec4 mvPosition;";fshader+="varying mediump vec4 transformedNormal;";fshader+="varying mediump vec2 vTextureCoord;";fshader+="uniform bool uUseTextures;";fshader+="uniform highp mat4 uMVMatrix;";fshader+="uniform highp mat4 uPMatrix;";fshader+="uniform highp mat4 uNMatrix;";fshader+="uniform mediump vec4 uModelColor;";fshader+="uniform mediump vec3 uAmbientColor[numLights];";fshader+="uniform mediump vec3 uPointLightingLocation[numLights];";fshader+="uniform mediump vec3 uPointLightingColor[numLights];";fshader+="uniform mediump float uPointLightingIntensity[numLights];";fshader+="uniform mediump float uSpecularFactor[numLights];";fshader+="uniform sampler2D uSampler;";fshader+="mediump vec4 fragmentColor;";fshader+="void main(void) {";if(QUARTZ.lightsArray.length>0){fshader+="for (int i = 0; i < numLights; i++) {";fshader+="    mediump vec3 lightDirection = normalize(mvPosition.xyz-uPointLightingLocation[i]);";fshader+="    mediump float lightDistance = length(uPointLightingLocation[i] - mvPosition.xyz);";fshader+="	  if(lightDistance < 0.0){lightDistance = lightDistance * - 1.0;}";fshader+="	  lightDistance = (1000.0-lightDistance) / 1000.0;"fshader+="    mediump float directionalLightWeighting = max(dot(transformedNormal.xyz, lightDirection), 0.0);";fshader+="    if(i==0){"fshader+="    	vLightWeighting  =  uAmbientColor[i] + uPointLightingColor[i] * lightDistance * directionalLightWeighting;";fshader+="    }"fshader+="	  else vLightWeighting = vLightWeighting + (uAmbientColor[i] + uPointLightingColor[i] * lightDistance * directionalLightWeighting);";fshader+="	   mediump vec3 E = normalize(-mvPosition.xyz);";fshader+="	   mediump vec3 R = reflect(lightDirection, transformedNormal.xyz);";fshader+="	  mediump float specular = pow( max(dot(R, E), 0.0), uSpecularFactor[i]);"fshader+="    vLightWeighting = vLightWeighting + uPointLightingColor[i] * specular;";fshader+="	  }";fshader+="	  if (uUseTextures) {";fshader+="		fragmentColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));";fshader+="	  }";fshader+="	  else fragmentColor = vec4(uModelColor);"fshader+="    gl_FragColor = vec4(fragmentColor.rgb * vLightWeighting, fragmentColor.a);"}else{fshader+="	  if (uUseTextures) {";fshader+="		fragmentColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));";fshader+="	  }";fshader+="	  else{";fshader+="	  fragmentColor = vec4(uModelColor);}"fshader+="	  gl_FragColor = fragmentColor;"}fshader+="}";return fshader}function initWebGL(canvas){gl=null;try{gl=canvas.getContext("webgl")||canvas.getContext("experimental-webgl")}catch(e){}if(!gl){alert("Unable to initialize WebGL. Your browser may not support it.");gl=null}return gl}QUARTZ.start=function(canvasid){var canvas=document.getElementById(canvasid);gl=initWebGL(canvas);if(gl){gl.clearColor(0,0,0,1.0);gl.enable(gl.DEPTH_TEST);gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.depthFunc(gl.LEQUAL);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);QUARTZ.cwidth=canvas.width;QUARTZ.cheight=canvas.height;gl.viewport(0,0,canvas.width,canvas.height)}}QUARTZ.draw=function(r,g,b){if(typeof r!==undefined)gl.clearColor(r,g,b,1.0);else gl.clearColor(0,0,0,1.0);gl.enable(gl.DEPTH_TEST);gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.depthFunc(gl.LEQUAL);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);var mv=mat4.create();mat4.identity(mv);QUARTZ.modelView=new Array();QUARTZ.modelView.push(mv);QUARTZ.getRoot().draw()}QUARTZ.init=function(canvasid){QUARTZ.start(canvasid);QUARTZ.draw()}